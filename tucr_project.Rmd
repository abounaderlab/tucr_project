---
title: 'A computational and molecular analysis of transcribed ultraconserved regions (T-UCRs) as lncRNAs in gliomas reveals an oncogenic role for uc.110'
author: "Myron Gibert Jr"
date: "January 27, 2020"
output: pdf_document
header-includes:
- \usepackage{hyperref}
- \hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={A computational and molecular analysis of transcribed ultraconserved regions (T-UCRs) as lncRNAs in gliomas reveals an oncogenic role for uc.110},
    pdfpagemode=FullScreen,
    }
toc: TRUE
---

\thispagestyle{empty}
\clearpage
\pagenumbering{arabic} 
\pagebreak

*https://www.nature.com/articles/sdata201861

This methodology is less relevant to GBM and LGG because there are only 5 normals in these datasets to compare GTex to.

CHESS data comes from http://ccb.jhu.edu/chess/

# Abstract

Gliomas represent the most common brain tumors.  Particularly, glioblastoma (GBM) is the most common and most deadly malignant brain tumor. Most glioma research has focused on protein-coding genes and much less on the non-coding transcripts that make up 98% of cellular RNA. Transcribed Ultra-Conserved Regions (TUCRs) represent an understudied class of molecules that are found conserved across multiple species. These transcripts are highly resistant to variation and are commonly deregulated in cancer, suggesting regulatory and functional importance.  Intergenic TUCRs specifically represent potential novel protein coding and non-coding transcripts, as they do not overlap with known genes.  We performed the first analysis of TUCRs in glioblastoma and low grade glioma (LGG).  Previously established methodologies were used to annotate TUCRs and confirm that they are transcribed.  Then, differentially expressed (DE) TUCRs were identified in GBM (n = 197) and LGG (n = 149), along with those who correlate with survival in GBM (n = 36) and LGG (n = 167).  TUCRs were then scored by their absolute and relative expression in GBM and LGG, frequency of deregulation, and correlation with survival.  These scores provide a means for prioritizing TUCRs for future experiments. Using a GBM and LGG RNA-Seq data to generate a list of co-regulated genes, a guilt-by-association analysis was performed to determine what biological processes and molecular functions may be shared by TUCRs and their co-regulated genes.  Lastly, as TUCRs represent fractions of larger host transcripts, we sought to identify and characterize the parent transcripts of intergenic TUCRs.  We propose that these host transcripts represent novel genes, with the TUCR itself serving as a component of these transcripts.  The results of this study provide an insight into several exciting future research directions.

# Introduction

Gliomas account for approximately 80% of all brain tumors.  In particular, glioblastoma (GBM) accounts for about half of all primary brain and central nervous system cancers.  It is also one of the most-deadly cancers. One-, five-, and ten-year survival rates for patients with GBM are 37 percent, 5%, and 3%, respectively.  Although there has been extensive research on protein coding genes and pathways in GBM and low grade gliomas (LGG), the current standard of care involves surgical resection and radiation, with limited targeted therapies.

Many targeted therapies in the context of GBM, LGG, and other malignancies focus on protein-coding genes.  And yet, these genes make up only a small portion of the transcriptome; ~90% of the genome is transcribed, but only ~2 percent of the transcriptome is then translated. The remainder of the transcriptome is represented by non-coding elements that can serve key regulatory roles. Of these elements, long non-coding RNAs (lncRNAs) have recently been determined to serve as important regulators of malignancy and potential therapeutic targets in cancer. These lncRNAs are transcribed RNA molecules that contain greater than 200 nucleotides but typically lack significant protein coding capabilities. 

There are several genetic regions that are “ultra-conserved” across species (UCR).  From these regions, Transcribed ultra-conserved regions (TUCRs) represent 481 unique transcribed regions of the genome that are greater than 200 base pairs in length and are highly conserved across multiple species, including human, mouse (100%), rat (100%), dog (98%), and chicken (95%) genomes. Due to their size (>200 nt) and lack of known associated protein products, TUCRs may function as lncRNAs.  The existence of highly conserved lncRNAs is significant, as lncRNAs are typically poorly conserved as a class of molecules.  TUCRs are highly resistant to variation, with the 106,767 conserved bases overlapping with as few as six canonical single nucleotide polymorphisms (SNPs).  Their expression is commonly deregulated in cancer.

Because of this, it is believed that these TUCRs may serve crucial regulatory roles in cancer. The non-coding RNA field is a growing one.  While only a single lncRNA paper was published in 2007, that number has exploded to 1342 publications by the year 2016.  Despite this explosion of interest in lncRNAs, very little is known of TUCRs.  In particular, the literature elucidating the expression, functions and mechanisms of action of TUCRs in GBM and/or LGG is nonexistent. Studying them therefore represents an untouched avenue for understanding novel oncogenic mechanisms and discovering new biomarkers and therapeutic targets for these diseases.

Here, we utilize contemporary and novel bioinformatics techniques to perform the first characterization of TUCR expression, function, and mechanism of action in GBM and LGG.  First, TUCRs were annotated and validated to confirm that annotations from 2010 are consistent with more recent databases.  Then, programming tools were used to identify TUCRs that are differentially expressed in GBM and LGG tissues.  TUCRs that are correlated with GBM and LGG patient survival were also identified.  Then, a guilt-by-association analysis was performed to predict TUCR functional roles using coregulated genes.  Lastly, we predict that intergenic TUCRs may represent markers for novel genes. To test this hypothesis, de novo transcript reassembly was used to identify transcripts present in RNA-Seq datasets in a genome agnostic manner.  Selection criteria were then used to identify potentially novel genes from the resulting dataset.

## Setup

### Set parameters

This initial section is used to set the dependent variables that are used for this analysis. 

The following variables can be set:
* countfilename is the name of the RNA-Seq feature count file that is generated in the "Generating count tables for survival and differential expression" section.  This can be any tab-delimited text file where the row names are the genes, the column names are the samples, and the cells are the generated counts.  This table is used for both survival and differential expression analyses.
* makekpmplots is a logical vector.  When set to TRUE, the script will generate Kaplan-Meier survival plots for each gene in the counts file.
* makerpkmoxplots is also a logical vector.  When set to TRUE, the script will generate reads per kilobase million boxplots for each gene, showing median RPKM, mean RPKM (red dot), and additional summary information. This is used to determine to what extent a gene is expressed across all samples
* repel is also a logical vector.  When set to true, the volcano summary plot for RNA-Seq expression data will contain labels for a given set of genes specified in the "Generating volcano plot to visualize DE genes"
* outputdir is a character variable containing the "output directory", or the location where all output files will go. This can be any characters enclosed in quotations marks (ex. "Outputs"). Set to "Outputs" to use the default outputs folder
* useintermediate is a logical vector.  When set to TRUE, the analysis will use a pregenerated gene correlation matrix for the guilt by association analysis.  Unless there is a specific reason to generate a new matrix (VERY memory intensive), this variable should be set to TRUE.
* deleteoutputs is a logical vector that should only be set to TURE or FALSE.  When set to true, the output directory will be repopulated after every program run.  If set to false, the program will only run if the output directory does not already exist in the working directory, to prevent the data from being overwritten.

### Install required programs

```{r setup, message = FALSE, warning=FALSE}
#knitr::opts_chunk$set(
#	#eval = FALSE,
#	echo = TRUE,
#	message = FALSE,
#	warning = FALSE
#)

## Variables

disease <- "GBM"

normal <- "cortex"

outputdir <- "Outputs_GBM_cortex_20240416"

outputdir_LGG <- "Outputs_LGG_cortex_20240416"

outputdir_GBM <- "Outputs_GBM_cortex_20240416"

filterannot <- "TUCR"

makeSNP <- TRUE

makeannotate <- TRUE

makelncRNA <- TRUE

makeBEDs <- TRUE

makeDE <- TRUE

RPKmethod <- "RPKM"

repel <- TRUE

makesurvival <- TRUE

makekpmplots <- TRUE

makeSuvivalplots <- TRUE

makeRPKboxplots <- TRUE

makeFCplots <- TRUE

makecorrelations <- TRUE

useintermediate <- TRUE

makeGOterms <- TRUE

checkcor <- 0.3

## Load Programs

if (!require("jsonlite")) install.packages("jsonlite")
library("jsonlite")

if (!require("tidyjson")) install.packages("tidyjson")
library("tidyjson")

if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")

if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")

if (!require("ggforce")) install.packages("ggforce")
library("ggforce")

if (!require("ggbreak")) install.packages("ggbreak")
library("ggbreak")

#if (!require("pathwork")) install.packages("pathwork")
#library("pathwork")

if (!require("ggrepel")) install.packages("ggrepel")
library("ggrepel")

if (!require("ggfortify")) install.packages("ggfortify")
library("ggfortify")

if (!require("ggdendro")) install.packages("ggdendro")
library("ggdendro")

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if (!requireNamespace("DESeq2", quietly = TRUE))BiocManager::install("DESeq2")
library("DESeq2")

if (!require("survival")) install.packages("survival")
library("survival")

if (!require("broom")) install.packages("broom")
library("broom")

if (!requireNamespace("limma", quietly = TRUE))BiocManager::install("limma")
library("limma")

if (!require("Tmisc")) install.packages("Tmisc")
library("Tmisc")

if (!require("survminer")) install.packages("survminer")
library("survminer")

if (!require("corrr")) install.packages("corrr")
library("corrr")

if (!require("here")) install.packages("here")
library("here")

if (!require("lessR")) install.packages("lessR")
library("lessR")

if (!require("splitstackshape")) install.packages("splitstackshape")
library(splitstackshape)

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

if (!require('org.Hs.eg.db')) BiocManager::install('org.Hs.eg.db')
library(org.Hs.eg.db)

if (!require('GO.db')) BiocManager::install('GO.db')
library(GO.db)

if (!require('limma')) BiocManager::install('limma')
library(limma)

if (!require("ggthemes")) install.packages('ggthemes', dependencies = TRUE)
library(ggthemes)

if (!require("gplots")) 
install.packages("gplots")
library(gplots)

if (!require("ggsignif")) 
install.packages("ggsignif")
library(ggsignif)

#if (!require("heatmap.plus")) 
#install.packages("heatmap.plus")
#library(heatmap.plus)

if (!require("RColorBrewer")) 
install.packages("RColorBrewer")
library(RColorBrewer)

if (!require("reshape2")) 
install.packages("reshape2")
library(reshape2)

if (!require("gridExtra")) 
install.packages("gridExtra")
library(gridExtra)

if (!require("dendextend")) 
install.packages("dendextend")
library(dendextend)

if (!require("plyr")) 
install.packages("plyr")
library(plyr)

if (!require("magick")) 
install.packages("magick")
library(magick)

if (!require("png")) 
install.packages("png")
library(png)

if (!require("scales")) 
install.packages("scales")
library(scales)

if (!require("ggsci")) 
install.packages("ggsci")
library(ggsci)

if(!dir.exists(outputdir)){
  dir.create(outputdir)
}

```

```{r readdata}

## read data

t_countfile <- paste(disease,"mergedcounts.txt",sep="_")

#t_countfile <- "Myron_RNASEQ-20220225_mergedcounts.txt"

#t_metadatafile <- "Myron_RNASEQ_metadata.csv"

n_countfile <- paste(normal,"mergedcounts.txt",sep="_")

t_metadatafile <- paste(disease,"tcga_metadata.csv",sep="_")

n_metadatafile <- paste(normal,"gtex_metadata.csv",sep="_")

t_seqdepthfile <- paste(disease,"seqdepth_counts.csv",sep="_")

n_seqdepthfile <- paste(normal,"seqdepth_counts.csv",sep="_")

#intermediatefile <- paste(disease,"matrixintermediate.Rdata",sep="_")

## Merge Data

if(!is.na(n_countfile)){
  mergedcounts <- read.table(t_countfile,header = TRUE)
  
  normalcounts <- read.table(n_countfile,header = TRUE) 
  
  mergedcounts <- mergedcounts %>% left_join(normalcounts,by=c("id")) %>%
    dplyr::select(-chrom.y,-start.y,-end.y,-strand.y,-tag.y,-annot.y,-alias.y) %>%
    distinct()
  
  metadata <- 
  read_csv(file = t_metadatafile)
  
  n_metadata <- 
  read_csv(file = n_metadatafile)
  
  rm(normalcounts)
  
  metadata <- rbind(metadata,n_metadata)
  
  rm(n_metadata)
  
  seqdepth <- read.csv(file = t_seqdepthfile)
  
  n_seqdepth <- read.csv(file = n_seqdepthfile)
  
  seqdepth <- rbind(seqdepth,n_seqdepth)
  
  rm(n_seqdepth)
  
}else{
    mergedcounts <- read.table(t_countfile,header = TRUE)

    metadata <- read_csv(file = t_metadatafile)
    
    metadata <- read_csv(file = t_metadatafile)
    
    seqdepth <- read.csv(file = t_seqdepthfile)
}

```


```{r tinytex, include=FALSE}
## INSTALLING LATEX FOR RMARKDOWN

#RMarkdown requires LaTex to create pdf documents as an output. More information can be found [here](https://bookdown.org/yihui/rmarkdown/pdf-document.html). Alternatively, output can be set to "html_document" or "word_document". End users may install LaTex by setting the "wanttinytex" variable to FALSE and running the following script:

#Install tinytex to let RMarkdown create a pdf document? Default: wanttinytex <- FALSE
wanttinytex <- TRUE

if(tinytex:::is_tinytex()==FALSE && wanttinytex == TRUE){
if (!require("tinytex")) install.packages("tinytex")
tinytex::install_tinytex()
}
```

# Section 1: Transcribed Ultra-conserved Regions (TUCRs) are a broad class of molecules

## Results

TUCRs are a broad class of molecules spanning the entire human genome.  Many TUCRs are contained within coding and non-coding transcripts.  Some TUCRs are exonic and are contained within an exon of the “host” gene (Figure 1A).  Others are contained within an intron instead (Figure 1B).  Some TUCRs straddle a region that spans exonic and intronic regions of the host gene (intronic/exonic) (Figure 1C), and others are not contained within a known genetic element at all (intergenic) (Figure 1D). Each of the 481 TUCRs were previously annotated in 2010.  Here, we provide an updated annotation that includes scientific discoveries made in the intervening decade (Figure 1E).  Through manual annotation, we have identified 46 exonic, 150 intronic, 67 intronic/exonic, and 218 intergenic TUCRs.  The full list of these annotations is available as a supplement (Supplementary Table 1)

It is critical that we confirm that TUCRs are transcribed to an extent that is comparable to known protein and non-coding genes.  Much of the genome is transcribed, but a relatively small fraction represents functional transcripts and genes.  The rest is considered transcriptional “noise”.  We sought to confirm that TUCRs do not represent transcriptional noise, but functional genomic units.

To analyze the transcription of TUCRs, we evaluated the local chromatin landscape and compared it to that of protein coding genes, non-coding RNAs, and randomized control genomic intervals.  We specifically wanted to focus on H3K4me3, a marker for open chromatin, and RNA Pol.II, which is involved in the transcription of many non-coding RNAs.  Using GBM U87 CHIP-Seq data, we performed two separate analyses of epigenetic density.  

First, publicly available U87 H3K4me3 and RNA Pol.II CHIP-Seq data were downloaded and processed. Then, we identified the nearest epigenetic marker to each TUCR and compared these results to randomized control intervals of a similar length, protein coding genes, and various non-coding elements. These analyses were performed using H3K4me3 (Figure 2A) and RNA Pol.II (Figure 2B) binding sites. Then, we considered the density of H3K4me3 and RNA Pol.II binding within a 10 kilobase (kb) window up- and downstream of each class of gene (Control, TUCR, lncRNA, and mRNA).  Fisher’s exact test was used to confirm that the chromatin landscape is more significantly enriched for H3K4me3 and RNA Pol.II than a random control interval and is more consistent with coding and non-coding genes. (Figure 2C) 

## Methodology

### Setting color palette

```{r colors}

paper_black = "#000000"
  
paper_gold = "#EAA304"
  
paper_green2 = "#20C799"
  
paper_yellow = "#F0E442"
  
paper_blue = "#017DC3"
  
paper_lightblue = "#58AFE0"
  
paper_skyblue = "#A5DFFF"
  
paper_orange = "#D55E00"
  
paper_purple = "#8C004C"
  
paper_gray = "#CAC4C4"
  
paper_red = "#C30223"
  
paper_darkpink = "#DA7C8C"
  
paper_pink = "#FFCCD5"

paper_green = "#54BB44"
  
paper_red2 = "#CA465C"
  
paper_turq = "#20C799"

```


### Generate Figure 1E for TUCR annotation

Figures 1A-1D were manually generated using Microsoft Powerpoint. TUCRs were then manually annotated, creating the "hg38.ultraconserved.bed" file provided in this repository.  As previously mentioned, we have identified 46 exonic, 150 intronic, 67 intronic/exonic, and 218 intergenic TUCRs. Figure 1E was generated using GGPlot2.

In the following code chunk, if the variable "makeannotate" is set to true, all subsequent lines will be run.  The chunk then reads in the "hg38.ultraconserved.bed" file and compiles the relevant information into a proportion ring chart as depicted in Figure 1E. The results are placed in the output directory as defined by the variable outputdir.

```{r Section1_annotation}
if(makeannotate == TRUE){
#Read in Firgure 1A
#figure1a_d_png <- readPNG("./FigureFiles/Figure1A-D.png")
#figure1a_d <- ggplot() + background_image(figure1a_d_png)

#figure1b_png <- readPNG("./FigureFiles/Figure1B.png")
#figure1b <- ggplot() + background_image(figure1b_png)

#figure1c_png <- readPNG("./FigureFiles/Figure1C.png")
#figure1c <- ggplot() + background_image(figure1c_png) 

#figure1d_png <- readPNG("./FigureFiles/Figure1D.png")
#figure1d <- ggplot() + background_image(figure1d_png) 
  
tucr_annot <- read.table("TUCRhostgenes.bed",header=FALSE) %>%
  filter(V14 != "TUCR" & V7 != "intergenic") %>%
  dplyr::select("alias"=V4,"host"=V13,"host_annot"=V15)

#length(unique(tucr_annot$TUCR))

allTUCRs <- read.table("hg38.ultraconserved.bed",header=TRUE) 

tucrjoiner <- allTUCRs %>%
  left_join(tucr_annot,by="alias") %>%
  mutate(newannot = ifelse(is.na(host),"intergenic",annot)) %>%
  dplyr::select(-annot,"annot"=newannot)

tucrfigure1 <- tucrjoiner %>%
  dplyr::select(alias,annot) %>%
  distinct() %>%
  group_by(annot) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent = count/sum(count)) %>%
  arrange(desc(count)) %>%
#Determine label positions
  mutate(lab.ypos = cumsum(count) - 0.5*count)

#Set factor levels
names(tucrfigure1)[names(tucrfigure1) == 'annot'] <- 
  'Annotation'

#Create Chart
figure1e <- ggplot(tucrfigure1, aes(x=2,y=count,fill=Annotation))          + 
  geom_bar(
    stat="identity",#colour="black", 
    width = 1)                                                          +
  geom_text(
    aes(y = lab.ypos, label = count), 
    color = "black",size=5)                                                    + 
  coord_polar("y", start=0)                                             + 
  scale_fill_manual(values=c(paper_red,paper_purple,paper_green,paper_blue))  + 
  ggtitle(paste("TUCR Genomic Location"))                               + 
  guides(colour = guide_legend(override.aes = list(size=10))) +
        theme(plot.title = element_blank(),
              axis.title = element_blank(),
              axis.text.y = element_blank(),
              axis.text.x = element_blank(),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_blank(),legend.position="none",legend.title=element_blank(),
legend.text = element_text(size = 15),
axis.ticks = element_blank(), 
      legend.box.spacing = unit(0, "pt"),
legend.margin=margin(0,0,0,0)) +
  xlim(0.5, 2.5)
  
figure1e

#figure1 <- ggarrange(figure1a_d,figure1e,
#                    labels = c("", "E"),
#                    ncol = 1, nrow = 2)

#Save Chart to output directory
ggsave(file=paste(outputdir,"/",disease,"_tucr_annotation.png",sep=""),
       plot = print(figure1e), 
       dpi = 300,
       height = 4.75,
       width = 4.75)

################################

allgenes <- read_delim("allgenes.bed",delim="\t",col_names=FALSE) %>% 
  filter(X7 != "TUCR") %>%
  group_by(X8) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent = count/sum(count)) %>%
  arrange(desc(count)) %>%
#Determine label positions
  mutate(lab.ypos = cumsum(count) - 0.5*count,Annotation = X8,test="expected") %>%
  dplyr::select(Annotation,percent,test)

tucrfigure2 <- tucrjoiner %>% 
  filter(annot != "intergenic") %>%
  group_by(host_annot) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent = count/sum(count)) %>%
  arrange(desc(count)) %>%
#Determine label positions
  mutate(lab.ypos = cumsum(count) - 0.5*count,test="observed") 

#Set factor levels
names(tucrfigure2)[names(tucrfigure2) == 'host_annot'] <- 
  'Annotation'

tucrfigure2 <- tucrfigure2 %>%
  dplyr::select(Annotation,percent,test)

tucrfigure3 <- rbind(tucrfigure2,allgenes) %>%
  filter(Annotation != "misc_RNA") %>%
  arrange(desc(test))

tucrfigure3$test <- factor(tucrfigure3$test,      # Reordering group factor levels
                         levels = c("expected","observed"))

figure1f <-   ggplot(tucrfigure3, aes(x=Annotation,y=as.numeric(percent),fill=test))   +
  geom_bar(stat="identity", 
           #color = "black",
           width=0.7,position="dodge") +
  
  scale_fill_manual(values = c(paper_red2,paper_turq)) +
  #scale_y_continuous(expand=expansion(mult=c(0,0.15))) +
  #geom_text(
  #  aes(label=round(value,2)), 
  #  vjust=1.6, 
  #  color="black", 
  #  size=rel(4))                                                      #+ 
  #ggtitle(paste("TUCRs are enriched for \n RNA Pol.II, H3K4me3,"))  + 
  xlab("Host Gene Annotation")                                           + 
  ylab("Proportion")                                           +
  #ggtitle(annot) +
  theme(
    #plot.title = element_text(
    #  size=rel(1.5), 
    #  face="bold",hjust = 0.5),
    #plot.title = element_text(
    #  size = rel(1.5),hjust=0.5, 
    #  face="bold"),
    strip.background = element_rect(fill="white"),
    plot.title = element_text(size=rel(3.0), face="bold",hjust = 0.5),
    axis.title = element_text(size = rel(2.0), face="bold"),
    axis.text = element_text(size = rel(2.0)),
    axis.text.x = element_text(angle=45,vjust=0.5),
    strip.text = element_text(size = rel(3.0), face="bold"),
    legend.title = element_blank(),
    legend.position = "top",
    legend.text = element_text(size = rel(2.0)),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")) 

figure1f

#figure1 <- ggarrange(figure1a_d,figure1e,
#                    labels = c("", "E"),
#                    ncol = 1, nrow = 2)

#Save Chart to output directory
ggsave(file=paste(outputdir,"/",disease,"_tucr_host_annotation.png",sep=""),
       plot = print(figure1f), 
       dpi = 300,
       height = 7,
       width = 6)
}
```

```{r tucr_locations}

#Read in Data
tucr_annot <- read.table("hg38.ultraconserved.bed",header=TRUE) %>%
  dplyr::select(chrom,start,end,alias,annot) %>%
  mutate(chromosome=str_remove(chrom,"chr"),
         chromnum=ifelse(chromosome=="X",23,
                  ifelse(chromosome=="Y",24,
                  ifelse(chromosome=="M",25,as.numeric(chromosome))))) %>%
  dplyr::select(chrom,start,end,alias,annot,chromnum)

hg38_chromsizes <- read.table("hg38_chromsizes.txt") %>%
  dplyr::select("chrom"=V1,"chromend"=V3,"chromnum"=V4)

hg38_subtract <- read.table("hg38_subtract.txt") %>%
  mutate(row = "interval",annot = "not conserved") %>%
  dplyr::select("chrom" = V1,"start" = V2, "end" = V3,"alias"=row,annot,"chromnum"=V4)
  
tucr_locations <- rbind(tucr_annot,hg38_subtract) %>%
  dplyr::group_by(chrom) %>%
  mutate(chromend = max(as.numeric(end),na.rm=TRUE)) %>%
  ungroup() %>%
  arrange(chromnum,start)

chrom_order <- c("chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", 
                 "chr8", "chr9", "chr10", "chr11", "chr12", "chr13", "chr14", 
                 "chr15", "chr16", "chr17", "chr18", "chr19", "chr20", "chr21", 
                 "chr22", "chrX", "chrY", "chrM")
chrom_key <- setNames(object = as.character(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 
                                              12, 13, 14, 15, 16, 17, 18, 19, 20, 
                                              21, 22, 23, 24, 25)), 
                      nm = chrom_order)
chrom_key2 <- rev(chrom_key)
chrom_order <- factor(x = chrom_order, levels = rev(chrom_order))

tucr_annot[["annot"]] <- factor(x = tucr_annot[["annot"]], 
                                      levels = c("exonic","intergenic","exonic_intronic","intronic"))

tucr_annot <- tucr_annot %>%
  mutate(test = ifelse(annot == "intronic",paper_blue,
                ifelse(annot == "exonic",paper_red,
                ifelse(annot == "intergenic",paper_green,paper_purple))))

p <- ggplot() + 
    # base rectangles for the chroms, with numeric value for each chrom on the x-axis\
    geom_rect(data = hg38_chromsizes, aes(xmin = as.numeric(26-chromnum) - 0.3, 
                                      xmax = as.numeric(26-chromnum) + 0.3, 
                                      ymax = as.numeric(chromend), ymin = 0),color="black",fill="lightgray") +
    geom_rect(data = tucr_annot, aes(xmin = as.numeric(26-chromnum) - 0.3, 
                                      xmax = as.numeric(26-chromnum) + 0.3, 
                                      ymax = as.numeric(end), ymin = as.numeric(start),color=test,fill=test)) +
    scale_fill_identity() +
    scale_color_identity() +
        # rotate the plot 90 degrees
    coord_flip() +
    # black & white color theme 
    theme(plot.title = element_blank(),
      text = element_text(size = 20), 
          axis.title = element_text(size = rel(1.5), face="bold"),
          axis.text.y = element_text(colour = "black",size = rel(1.5)),
          axis.text.x = element_text(colour = "black",size = rel(1.5)),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(),
          legend.position="none",
          legend.title=element_blank(),
          legend.text=element_text(size=12.5)) +
    # give the appearance of a discrete axis with chrom labels
    scale_x_discrete(name = "chromosome", limits = rev(names(chrom_key))) +
    scale_y_continuous(name = "region (bp)",labels = comma,position = "right") +
    # add bands for centromeres
    #scale_fill_manual(values = group.colors) +
    ggtitle("TUCR Genomic Locations") 
    # supress scientific notation on the y-axis

p

p2 <- ggplot() + 
    # base rectangles for the chroms, with numeric value for each chrom on the x-axis\
    geom_rect(data = hg38_chromsizes, aes(xmin = as.numeric(chromnum) - 0.3, 
                                      xmax = as.numeric(chromnum) + 0.3, 
                                      ymax = as.numeric(chromend), ymin = 0),color="black",fill="lightgray") +
    geom_rect(data = tucr_annot, aes(xmin = as.numeric(chromnum) - 0.3, 
                                      xmax = as.numeric(chromnum) + 0.3, 
                                      ymax = as.numeric(end), ymin = as.numeric(start)),color="black",fill="black") +
    
    # rotate the plot 90 degrees
    coord_flip() +
    # black & white color theme 
    theme(text = element_text(size = 20), axis.text.x = element_text(colour = "black",size = 10 ),
          axis.text.y = element_text(size = rel(2),colour = "black"),
          axis.title = element_text(size = rel(2), face="bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank()) +
    guides(colour = "black",fill = guide_legend(override.aes = list(size=5))) +
    # give the appearance of a discrete axis with chrom labels
    scale_x_discrete(name = "chromosome", limits = names(chrom_key)) +
    scale_y_continuous(name = "region (bp)",label_comma) +
    # add bands for centromeres
    #scale_fill_manual(values = group.colors) +
    ggtitle("TUCR Genomic Locations") 
    # supress scientific notation on the y-axis
    

#ggsave(file=paste(outputdir,"/",disease,"_tucr_locations.png",sep=""),
#       plot = print(p2),height=10,width=15, 
#       dpi = 600)

ggsave(file=paste(outputdir,"/",disease,"_tucr_locations_annotated.png",sep=""),
       plot = print(p),height=10,width=16, 
       dpi = 600)


```

## Generate BED Files for each annotation category

```{r annot_bed, eval = TRUE}

tucr_annot <- read.table("hg38.ultraconserved.bed",header=TRUE)

annotations <- unique(as.character(tucr_annot$annot))

for(i in 1:length(annotations)){
  filter_annot <- annotations[i]
  tucr_annot2 <- tucr_annot %>%
    filter(annot == filter_annot) %>%
    write_delim(file = paste("BEDFiles/",filter_annot,"_hg38.ultraconserved.bed",sep=""),delim="\t")
}

```


## Acquiring SNPs

Bejerano et al, 2004, reported that TUCRs are resistant to variation. We sought to update our understanding of TUCR variation using the latest resources.  The following code chunk using bash scripting to download and decompress the most recent database for known SNPs (as of 2021) by chromosome.

```{bash Section1_SNPget, eval = FALSE}
mkdir SNPs

cd SNPs

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_1.bed.gz
gunzip bed_chr_1.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_10.bed.gz
gunzip bed_chr_10.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_11.bed.gz
gunzip bed_chr_11.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_13.bed.gz
gunzip bed_chr_13.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_12.bed.gz
gunzip bed_chr_12.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_14.bed.gz
gunzip bed_chr_14.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_15.bed.gz
gunzip bed_chr_15.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_16.bed.gz
gunzip bed_chr_16.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_17.bed.gz
gunzip bed_chr_17.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_18.bed.gz
gunzip bed_chr_18.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_19.bed.gz
gunzip bed_chr_19.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_2.bed.gz
gunzip bed_chr_2.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_20.bed.gz
gunzip bed_chr_20.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_21.bed.gz
gunzip bed_chr_21.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_22.bed.gz
gunzip bed_chr_22.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_3.bed.gz
gunzip bed_chr_3.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_4.bed.gz
gunzip bed_chr_4.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_5.bed.gz
gunzip bed_chr_5.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_6.bed.gz
gunzip bed_chr_6.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_7.bed.gz
gunzip bed_chr_7.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_8.bed.gz
gunzip bed_chr_8.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_9.bed.gz
gunzip bed_chr_9.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_X.bed.gz
gunzip bed_chr_X.bed.gz

wget ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b151_GRCh38p7/BED/bed_chr_Y.bed.gz
gunzip bed_chr_Y.bed.gz

```

### Getting SNP intersects for genes

After downloading and unzipping the SNP genomic location files, we then use bedtools to identify and report all SNPs that overlap with TUCR bases/nucleotides.  

The following chunk contains a for-loop that does this for all bed files in the directory created during the previous step for TUCRs.  These were then compared to results for protein coding genes, long non-coding RNAs, antisense RNAs, and miscellaneous RNAs to determine comparable resistance to variation.

```{bash Section1_SNPintersect, eval = FALSE}

mkdir SNPs/

for input in BEDFiles/*bed
do
masterfilename=$(echo "${input##*/}" | awk -F ".bed" '{print $1}')
echo $masterfilename
for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

intersectBed -a $input -b $bed -wa -wb > $name.$masterfilename.SNPs.bed

done

cat *.$masterfilename.SNPs.bed > merged.$masterfilename.SNPs.bed

rm $name.*
done

### ALL TUCRs ###
for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a BEDFiles/hg38.ultraConserved.bed -b $bed -wa -wb > $name.TUCR.SNPs.bed

done

cat SNPBeds/*.TUCR.SNPs.bed > merged_TUCR_SNPs.bed

rm SNPBeds/*TUCR.SNPs.bed

### Exonic TUCRs ###
for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a BEDFiles/exonic_hg38.ultraConserved.bed -b $bed -wa -wb > $name.exonicTUCR.SNPs.bed

done

cat SNPBeds/*.exonicTUCR.SNPs.bed > merged_exonicTUCR_SNPs.bed

rm SNPBeds/*exonicTUCR.SNPs.bed

### Intronic TUCRs ###
for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a BEDFiles/intronic_hg38.ultraConserved.bed -b $bed -wa -wb > $name.intronicTUCR.SNPs.bed

done

cat SNPBeds/*.intronicTUCR.SNPs.bed > merged_intronicTUCR_SNPs.bed

rm SNPBeds/*intronicTUCR.SNPs.bed

### Exonic_Intronic TUCRs ###
for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a BEDFiles/exonic_intronic_hg38.ultraConserved.bed -b $bed -wa -wb > $name.exonicintronicTUCR.SNPs.bed

done

cat SNPBeds/*.exonicintronicTUCR.SNPs.bed > merged_exonicintronicTUCR_SNPs.bed

rm SNPBeds/*exonicintronicTUCR.SNPs.bed

### Intergenic TUCRs ###

for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a BEDFiles/intergenic_hg38.ultraConserved.bed -b $bed -wa -wb > $name.intergenicTUCR.SNPs.bed

done

cat SNPBeds/*.intergenicTUCR.SNPs.bed > merged_intergenicTUCR_SNPs.bed

rm SNPBeds/*intergenicTUCR.SNPs.bed

### coding genes ###

for bed in SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a CHESScoding.bed -b $bed -wa -wb > $name.TUCR.SNPs.bed

done

cat SNPBeds/*coding.SNPs.bed > merged_coding_SNPs.bed

rm SNPBeds/*coding.SNPs.bed

### lncRNAs ###

for bed in SNPs/SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a CHESSlncRNA.bed -b $bed -wa -wb > $name.lncRNA.SNPs.bed

done

cat *lncRNA.SNPs.bed >  SNPs/merged_lncRNA_SNPs.bed

rm *lncRNA.SNPs.bed
rm *CHESSlncRNA.bed

### antisense RNAs ###

for bed in SNPs/SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a CHESSantisense.bed -b $bed -wa -wb > $name.antisense.SNPs.bed

done

cat *antisense.SNPs.bed >  SNPs/merged_antisense_SNPs.bed

rm *antisense.SNPs.bed
rm CHESSantisense.bed

### miscRNAs ###

for bed in SNPs/SNPBeds/bed_chr*
do

name=$(echo "${bed%.*}")
echo $name

intersectBed -a CHESSmisc.bed -b $bed -wa -wb > $name.misc.SNPs.bed

done

cat *misc.SNPs.bed >  SNPs/merged_misc_SNPs.bed

rm *misc.SNPs.bed
rm CHESSmisc.bed
```

### Count intersecting SNPs

This file counts the number of rows in each file.  Each row represents a single SNP, thus providing a count of all overlapping SNPs by annotation category.

```{bash Section1_SNPcount, eval = FALSE}

wc -l merged_TUCR_SNPs.bed

wc -l merged_exonicTUCR_SNPs.bed

wc -l merged_intronicTUCR_SNPs.bed

wc -l merged_exonicintronicTUCR_SNPs.bed

wc -l merged_intergenicTUCR_SNPs.bed

wc -l merged_coding_SNPs.bed

wc -l merged_lncRNA_SNPs.bed

wc -l merged_antisense_SNPs.bed

wc -l merged_misc_SNPs.bed

```

### Generate SNP proportion graph

```{r Section1_SNPgraph, eval = FALSE}
if(makeSNP == TRUE){
tucr_SNP <- read.csv("tucr_SNPs.csv")

p <- ggplot(tucr_SNP, aes(x=reorder(annot,order),y=proportion*100,fill=reorder(annot,order))) + 
  geom_bar(stat="identity", width = 0.7
           #,color = "black"
    ) + 
  geom_text(aes(label=round(proportion*100,3)), vjust=1.6, color="black", size=5) + 
  scale_fill_manual(values=c(paper_purple,paper_yellow,paper_blue,paper_green,paper_orange)) + 
  #ggtitle(paste("TUCRs are less susceptible to variation than other genes")) + 
  xlab("gene annotation") + 
  ylab("Percent variant nucleotides (SNPs)") + 
  theme(
    plot.title = element_text(size=rel(1.5), face="bold",hjust = 0.5),
    axis.title = element_text(size = rel(1.5), face="bold"),
    axis.text.x = element_text(size = rel(1.5),angle = 90),
    axis.text.y = element_text(size = rel(1.5)),
    legend.title = element_blank(),
    legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black"))

p

ggsave(file=paste(outputdir,"/",disease,"_SNPGraph.png",sep=""),
       plot = print(p),
       width = 4, 
       height = 5, 
       dpi = 600)
}
```

### Aquire the data using the SRA toolkit

```{bash Section1_SRAToolkit, eval = FALSE}

#using SRA Toolkit version 2.10.5

#Transcriptional Amplification in Tumor Cells with Elevated c-Myc
#https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE36354

#CHIP-Seq U87-H3K4me3 

prefetch SRR444442

#CHIP-Seq U87-RNAPolII

prefetch SRR444478

#CHIP-Seq U87-H3K27ac

prefetch SRR444436

#ATAC-Seq U87-1

prefetch SRR8723798

#ATAC-Seq U87-2

prefetch SRR8723799

#ATAC-Seq U87-3

prefetch SRR8723800

```

### Generate fastq files

```{bash Section1_fastq, eval = FALSE}

for sra in SRR*
do
echo $sra
fastq-dump $sra
done

```

### Build hg38 genome

```{bash Section1_build_hg38genome, eval = FALSE}

wget https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.fa.gz
gunzip hg38.fa.gz

#Rivanna only.  Skip otherwise.
module load gcc/7.1.0
module load bowtie2/2.2.9

bowtie2-build hg38.fa hg38 

```

### Align fastq files to reference genome

```{bash Section1_sam, eval = FALSE}

for fq in *.fastq.gz
do
name=$(echo $fq | awk -F".fastq.gz" '{print $1}')
echo $name
bowtie2 -q -x hg38 -U $fq -S $name.sam
done


for fq in *.fastq
do
name=$(echo $fq | awk -F".fastq" '{print $1}')
echo $name
bowtie2 --no-unal -q -x hg38 -U $fq -S $name.sam
done

```

### Convert sam to bam

```{bash Section1_bam, eval = FALSE}

for sam in *.sam
do
name=$(echo $sam | awk -F".sam" '{print $1}')
echo $name
samtools view -b $sam | samtools sort -o $name.bam
done
rm *sam

```

### Index bam files

```{bash Section1_index, eval = FALSE}

for bam in *bam
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools index $bam
done

```

### Convert to bed

I got this methodology from [here](https://github.com/stevekm/reference-annotations/blob/master/Makefile) since my other methods were not working.

```{bash Section1_callpeaks, eval = FALSE}

macs2 callpeak -t SRR444442.bam -n SRR444442 -g hs --nomodel
macs2 callpeak -t SRR444478.bam -n SRR444478 -g hs --nomodel
macs2 callpeak -t SRR444436.bam -n SRR444436 -g hs --nomodel
macs2 callpeak -t SRR8723798.bam -n SRR8723798 -g hs --nomodel
macs2 callpeak -t SRR8723799.bam -n SRR8723799 -g hs --nomodel
macs2 callpeak -t SRR8723800.bam -n SRR8723800 -g hs --nomodel

for SRR in $(find . -name 'SRR8723*')
do

name="${SRR##*/}"
echo $name
bam=$(echo $name/$name.bam)
echo $bam

macs2 callpeak -t $bam -n $name -g hs --nomodel

done

wc -l *Peak

cat SRR444442._peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > h3k4me3.bed
cat SRR444478._peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > pol2.bed
cat SRR444436._peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > h3k27ac.bed
cat SRR8723798_peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > U87_ATAC1.bed
cat SRR8723799_peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > U87_ATAC2.bed
cat SRR8723800_peaks.narrowPeak | cut -f 1-4 | grep -v KI | grep -v MT | grep -v GL | grep -v JH | grep -v KB | grep -v chrM > U87_ATAC3.bed
```

```{bash ATAC, eval = FALSE}

wget ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM3669nnn/GSM3669993/suppl/GSM3669993_U87_ATAC.highPValue.distal_intersect.H3K27Ac.bed.gz

gunzip GSM3669993_U87_ATAC.highPValue.distal_intersect.H3K27Ac.bed.gz

```

### Download Genome Annotation file and sort

```{bash Section1_referenceFile, eval = FALSE}

wget ftp://ftp.ensembl.org/pub/release-90/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz

gunzip Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz

samtools faidx Homo_sapiens.GRCh38.dna.primary_assembly.fa

awk -v OFS='\t' {'print $1,$2'} Homo_sapiens.GRCh38.dna.primary_assembly.fa.fai > hg38_genomeFile.txt

cat hg38_genomeFile.txt | grep -v KI | grep -v MT | grep -v GL | sed -e "s/^/chr/g" > temp

mv temp hg38_genomeFile.txt


bedtools sort -i pol2.bed -g hg38_genomeFile.txt > U87_pol2.sort.bed

bedtools sort -i h3k4me3.bed -g hg38_genomeFile.txt > U87_h3k4me3.sort.bed

bedtools sort -i h3k27ac.bed -g hg38_genomeFile.txt > U87_h3k27ac.sort.bed

```

```{bash, eval = FALSE}

wget http://ftp.ensembl.org/pub/release-105/fasta/mus_musculus/dna/Mus_musculus.GRCm39.dna.primary_assembly.fa.gz

gunzip Mus_musculus.GRCm39.dna.primary_assembly.fa.gz

samtools faidx hg38/hg38.fa
samtools faidx mm39/mm39.fa

awk -v OFS='\t' {'print $1,$2'} hg38/hg38.fa.fai > hg38/hg38_genomeFile.txt

cat hg38/hg38_genomeFile.txt | grep -v KI | grep -v MT | grep -v GL | sed -e "s/^/chr/g" > temp

mv temp hg38/hg38_genomeFile.txt

awk -v OFS='\t' {'print $1,$2'} mm39/mm39.fa.fai > mm39/mm39_genomeFile.txt

cat mm39/mm39_genomeFile.txt | grep -v KI | grep -v MT | grep -v GL | sed -e "s/^/chr/g" > temp

mv temp mm39/mm39_genomeFile.txt


awk -v OFS='\t' {'print $1,$2'} Mus_musculus.GRCm39.dna.primary_assembly.fa.fai > mm39_genomeFile.txt

cat mm39_genomeFile.txt | grep -v KI | grep -v MT | grep -v GL | sed -e "s/^/chr/g" > temp

mv temp mm39_genomeFile.txt

cat Mus_musculus.GRCm39.105.gtf | grep transcript_id | grep gene_id | convert2bed --do-not-sort --input=gtf - > mm39_genes.bed

```


### Generate Random Intervals and sort all files

```{bash Section1_sortbed, eval = FALSE}

bedtools shuffle -i BEDFiles/hg38.ultraConserved.bed -g hg38_genomeFile.txt -seed 03072022 > random_hg38.ultra
Conserved.bed

#bedtools shuffle -i pol2.bed -g hg38_genomeFile.txt > pol2shuff.bed
#bedtools sort -i pol2shuff.bed > pol2shuff.sort.bed

#bedtools shuffle -i h3k4me3.bed -g hg38_genomeFile.txt > h3k4me3shuff.bed
#bedtools sort -i h3k4me3shuff.bed > h3k4me3shuff.sort.bed

#bedtools sort -i hg38.ultraConserved.bed > hg38.ultraConserved.sort.bed

#bedtools sort -i TUCR_intergenic.bed > TUCR_intergenic.sort.bed

for bed in $(find BEDFiles/*.bed -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
echo $name

bedtools sort -g hg38_genomeFile.txt -i $bed > $name.sort.bed

done

rm *sort.sort.bed

rm BEDFiles/*sort.sort.bed

```

### BEDTOOLS FISHER 20230927

```{bash}

for bed in $(find * -name '*TUCR.bed')
do

name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools slop -b 4000 -i $bed -g hg38_genomeFile.txt > temp

bedtools sort -i temp -g hg38_genomeFile.txt > $name.sort.bed

rm temp

done

for bed in $(find * -name '*CHESS.bed')
do

name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools sort -g hg38_genomeFile.txt -i $bed > $name.sort.bed

done

for bed in $(find * -name '*promoters.bed')
do

name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools shuffle -i $bed -g hg38_genomeFile.txt -seed 09272023 > $name.shuffled.bed

bedtools sort -g hg38_genomeFile.txt -i $bed > $name.sort.bed

bedtools sort -g hg38_genomeFile.txt -i $name.shuffled.bed > $name.shuffled.sort.bed

done

rm *sort.sort.bed

for bed in $(find bedfiles/* -name '*.sort.bed')
do

name=$(echo "${bed##*/}" | awk -F ".sort.bed" '{print $1}')
echo $name

bedtools fisher -a $bed -b U87_pol2.sort.bed -g hg38_genomeFile.txt > fisher/$name.pol2.fisher

bedtools fisher -a $bed -b U87_h3k4me3.sort.bed -g hg38_genomeFile.txt > fisher/$name.h3k4me3.fisher

bedtools fisher -a $bed -b U87_h3k27ac.sort.bed -g hg38_genomeFile.txt > fisher/$name.h3k27ac.fisher

bedtools fisher -a $bed -b U87_ATAC1.bed -g hg38_genomeFile.txt > fisher/$name.ATAC1.fisher

bedtools fisher -a $bed -b U87_ATAC2.bed -g hg38_genomeFile.txt > fisher/$name.ATAC2.fisher

bedtools fisher -a $bed -b U87_enhancers.sort.bed -g hg38_genomeFile.txt > fisher/$name.enhancers.fisher

done

for SRR in $(find . -name 'SRR*')
do

name=$(echo "${SRR##*/}")
echo $name

cp $name/$name.fastq .

done

```


### Find closest spatial relations using bedtools closest

```{bash Section1_closest_PolII, eval = FALSE}

mkdir ./closest/

for bed in $(find BEDFiles/*.bed -name '*.sort.bed')
do

name=$(echo "${bed##*/}" | awk -F ".sort.bed" '{print $1}')
echo $name

bedtools closest -a $bed -b U87_pol2.sort.bed -g hg38_genomeFile.txt -d > ./closest/$name.closest.pol2.bed

done

for bed in $(find BEDFiles/*.bed -name '*.sort.bed')
do

name=$(echo "${bed##*/}" | awk -F ".sort.bed" '{print $1}')
echo $name

bedtools closest -a $bed -b U87_h3k4me3.sort.bed -g hg38_genomeFile.txt -d > ./closest/$name.closest.h3k4me3.bed

done

for bed in $(find BEDFiles/*.bed -name '*.sort.bed')
do

name=$(echo "${bed##*/}" | awk -F ".sort.bed" '{print $1}')
echo $name

bedtools closest -a $bed -b GSM3669993_U87_ATAC.highPValue.distal_intersect.H3K27Ac.bed -g hg38_genomeFile.txt -d > ./closest/$name.closest.h3k27ac.bed

done

U87_h3k27ac.sort.bed

```

### Generate TUCR "Windows"

```{bash Section1_slop, results="hide", eval = FALSE}

#bedtools slop -b 10000 -i hg38.ultraConserved.sort.bed -g hg38_genomeFile.txt > tucrs_pm10kb.bed

#bedtools slop -b 10000 -i TUCR_intergenic.sort.bed -g hg38_genomeFile.txt > intergenic_tucrs_pm10kb.bed

#bedtools slop -b 10000 -i CHESScoding.sort.bed -g hg38_genomeFile.txt > coding_pm10kb.bed

#bedtools slop -b 10000 -i CHESSlncRNA.sort.bed -g hg38_genomeFile.txt > lncRNAs_pm10kb.bed

#bedtools slop -b 10000 -i CHESSantisense.sort.bed -g hg38_genomeFile.txt > antisense_pm10kb.bed

bedtools slop -b 10000 -i CHESSmisc.sort.bed -g hg38_genomeFile.txt > temp

temp > CHESSmisc.sort.bed

rm temp

for bed in $(find * -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
echo $name

bedtools sort -i $bed -g hg38_genomeFile.txt > $name.sort.bed

done

for bed in $(find * -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
echo $name

bedtools slop -b 10000 -i $bed -g hg38_genomeFile.txt > $name.pm10kb.bed

bedtools sort -i $name.pm10kb.bed -g hg38_genomeFile.txt > $name.sort.bed

done

rm BEDFiles/*.pm10kb.bed

```

### Fisher

```{bash Section1_newfisher, results="hide", eval = FALSE}

mkdir Outputs/
mkdir Outputs/intersects/
mkdir Outputs/intersects/counts/
mkdir Outputs/Fisher/

for bed in $(find SpatialRelations/*.sort.bed -name '*.sort.bed')
do
name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools intersect -a $bed -b U87_pol2.sort.bed > Outputs/intersects/$name.pol2intersect.bed

bedtools fisher -a $bed -b U87_pol2.sort.bed -g hg38_genomeFile.txt > Outputs/Fisher/$name.pol2.fisher.bed

wc -l Outputs/intersects/$name.pol2intersect.bed > Outputs/intersects/counts/$name.pol2counts.bed

for i in {1..1000}
do

echo $i

bedtools shuffle -i U87_pol2.bed -g hg38_genomeFile.txt -seed $i > temp.bed

bedtools sort -i temp.bed -g hg38_genomeFile.txt > temp.sorted.bed

bedtools intersect -a $bed -b temp.sorted.bed > temp.bed

wc -l temp.bed >> Outputs/intersects/counts/$name.pol2counts.bed

done
done

for bed in $(find SpatialRelations/*.sort.bed -name '*.sort.bed')
do
name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools intersect -a $bed -b U87_h3k4me3.sort.bed > Outputs/intersects/$name.h3k4me3intersect.bed

bedtools fisher -a $bed -b U87_h3k4me3.sort.bed -g hg38_genomeFile.txt -f 0.05 > Outputs/Fisher/$name.h3k4me3.fisher.bed

wc -l Outputs/intersects/$name.h3k4me3intersect.bed > Outputs/intersects/counts/$name.h3k4me3counts.bed

done

for i in {1..1000}
do

echo $i

bedtools shuffle -i U87_h3k4me3.bed -g hg38_genomeFile.txt -seed $i > temp.bed

bedtools sort -i temp.bed -g hg38_genomeFile.txt > temp.sorted.bed

bedtools intersect -a $bed -b temp.sorted.bed > temp.bed

wc -l temp.bed >> Outputs/intersects/counts/$name.h3k4me3counts.bed

done
done

for bed in $(find BEDFiles/*.sort.bed -name '*.sort.bed')
do
name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools intersect -a $bed -b U87_h3k27ac.sort.bed > Outputs/intersects/$name.h3k27ac.intersect.bed

bedtools fisher -a $bed -b U87_h3k27ac.sort.bed -g hg38_genomeFile.txt > Outputs/Fisher/$name.h3k27ac.fisher.bed

wc -l Outputs/intersects/$name.h3k27ATACintersect.bed > Outputs/intersects/counts/$name.h3k27ATACcounts.bed

for i in {1..1000}
do

echo $i

bedtools shuffle -i U87_h3k27ac.sort.bed -g hg38_genomeFile.txt -seed $i > temp.bed

bedtools sort -i temp.bed -g hg38_genomeFile.txt > temp.sorted.bed

bedtools intersect -a $bed -b temp.sorted.bed > temp.bed

wc -l temp.bed >> Outputs/intersects/counts/$name.h3k27ATACcounts.bed

done
done

mkdir SNPOutputs/
mkdir SNPOutputs/intersects/
mkdir SNPOutputs/intersects/counts/
mkdir SNPOutputs/Fisher/

for bed in $(find SpatialRelations/*.sort.bed -name '*.sort.bed')
do
name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

bedtools intersect -a $bed -b U87_h3k27ac.sort.bed > Outputs/intersects/$name.h3k27ac.intersect.bed

bedtools fisher -a $bed -b U87_h3k27ac.sort.bed -g hg38_genomeFile.txt > Outputs/Fisher/$name.h3k27ac.fisher.bed

wc -l Outputs/intersects/$name.h3k27ATACintersect.bed > Outputs/intersects/counts/$name.h3k27ATACcounts.bed

for i in {1..1000}
do

echo $i

bedtools shuffle -i U87_h3k27ac.sort.bed -g hg38_genomeFile.txt -seed $i > temp.bed

bedtools sort -i temp.bed -g hg38_genomeFile.txt > temp.sorted.bed

bedtools intersect -a $bed -b temp.sorted.bed > temp.bed

wc -l temp.bed >> Outputs/intersects/counts/$name.h3k27ATACcounts.bed

done
done

for bed in $(find bed* -name '*.bed')
do
name=$(echo "${bed##*/}" | awk -F ".bed" '{print $1}')
echo $name

tail -n +2 $bed >> mergedSNPs.bed

done

```

```{r Section1_newfisher_summary, eval=FALSE}

if(!dir.exists(paste(outputdir,"/SpatialRelations/",sep=""))){dir.create(paste(outputdir,"/SpatialRelations/",sep=""))}

allgenes <- read_delim("allgenes.bed",col_names = FALSE,delim = "\t")

i <- 1

for(i in 1:length(unique(allgenes$X8))){
  annot <- unique(allgenes$X8)[i] 
  
  print(annot)
  
  allgenes_filter <- allgenes %>%
    filter(X8 == annot) %>%
    write_delim(paste(outputdir,"/SpatialRelations/",annot,"_genelist.bed",sep=""),col_names=FALSE,delim="\t")
}

allgenes_filter <- allgenes %>%
    filter(X7 == "TUCR") %>%
    write_delim(paste(outputdir,"/SpatialRelations/TUCR_genelist.bed",sep=""),col_names=FALSE,delim="\t")

files <- list.files(path = "TUCR_lncRNA/counts/")

spatialdata <- ""

i <- 1

for(i in 1:length(files)){
  print(i)
  filename <- as.character(files[i])
  data <- read.table(paste("TUCR_lncRNA/counts/",filename,sep=""))
  truevalue <- as.numeric(data$V1[1])
  
  data <- data %>%
    mutate(V3 = ifelse(V1>=truevalue,1,0),median= median(V1,na.rm=TRUE),FC=as.numeric(as.character(V1))/as.numeric(as.character(median)),stdev=sd(FC,na.rm=TRUE),sum = sum(V3,na.rm = TRUE),p=(sum/1000),invlog10=(as.numeric(-log10(p))))
  
  medianvalue <- as.numeric(data$median[i])
  foldchange <- truevalue/medianvalue
  sdvalue <- as.numeric(data$stdev[i])
  sumvalue <- as.numeric(data$sum[i])
  pvalue <- as.numeric(data$p[i])
  invlog10value <- as.numeric(data$invlog10[i])
  
  rbinder <- as.character(c(as.character(filename),truevalue,medianvalue,foldchange,sdvalue,sumvalue,pvalue,invlog10value))
  spatialdata <- rbind(spatialdata,rbinder)
}

spatialdata <- as.data.frame(spatialdata[-1,])

colnames(spatialdata) <- c("file","intersectcount","median","foldchange","stdev","sum","p","invlog10_p")

cor(as.numeric(as.character(spatialdata$foldchange)),as.numeric(as.character(spatialdata$intersectcount)))
plot(as.numeric(as.character(spatialdata$foldchange)),as.numeric(as.character(spatialdata$intersectcount)))


spatialdata <- spatialdata %>%
  mutate(mark = ifelse(str_detect(file,"h3k27"),"H3K27Ac",
                                  ifelse(str_detect(file,"h3k4"),"H3K4me3",
                                  ifelse(str_detect(file,"pol2"),"RNA Pol.II","ERROR"
                                  ))),
         annot = ifelse(str_detect(file,"alltucr"),"All TUCRs",
                        ifelse(str_detect(file,"exonic"),"Exonic TUCR",
                        ifelse(str_detect(file,"intronic"),"Intronic TUCR",
                        ifelse(str_detect(file,"exon_intron"),"Exonic/Intronic TUCR",
                        ifelse(str_detect(file,"intergenic"),"Intergenic TUCR",
                        ifelse(str_detect(file,"coding"),"Protein Coding",
                        ifelse(str_detect(file,"lncRNA"),"LncRNA",
                        ifelse(str_detect(file,"antisense"),"Antisense RNA",
                        ifelse(str_detect(file,"misc"),"Small Noncoding RNA",
                        ifelse(str_detect(file,"random"),"Scrambled Negative Control","ERROR")))))))))),
         Order1 = ifelse(str_detect(file,"alltucr"),6,
                        ifelse(str_detect(file,"exonic"),7,
                        ifelse(str_detect(file,"intronic"),8,
                        ifelse(str_detect(file,"exon_intron"),9,
                        ifelse(str_detect(file,"intergenic"),10,
                        ifelse(str_detect(file,"coding"),2,
                        ifelse(str_detect(file,"lncRNA"),3,
                        ifelse(str_detect(file,"antisense"),4,
                        ifelse(str_detect(file,"misc"),5,
                        ifelse(str_detect(file,"random"),1,"ERROR")))))))))),
         Order2 = ifelse(str_detect(file,"h3k27"),3,
                                  ifelse(str_detect(file,"h3k4"),2,
                                  ifelse(str_detect(file,"pol2"),1,"ERROR"
                                  ))),
         errorbar = as.numeric(as.character(foldchange))+as.numeric(as.character(stdev)),
         datalabels = ifelse(as.numeric(as.character(p))<=0.001,"***",
                             ifelse(as.numeric(as.character(p))<=0.01,"**",
                             ifelse(as.numeric(as.character(p))<=0.05,"*","")))) %>%
  arrange(as.numeric(Order1),as.numeric(Order2)) %>%
  dplyr::mutate(Order = row_number())

```

## Find likelihood of TUCR spatial relationships

```{r fisher}

if(!dir.exists(paste(outputdir,"/SpatialRelations/",sep=""))){dir.create(paste(outputdir,"/SpatialRelations/",sep=""))}

if(!dir.exists(paste(outputdir,"/SpatialRelations/promoters",sep=""))){dir.create(paste(outputdir,"/SpatialRelations/promoters",sep=""))}

library(stringi)
library(stringr)

filenames <- list.files("./fisher_promoters")
#filenames <- list.files("./fisher")

#header <- data.frame(matrix(ncol = 5, nrow = 0))
header <- data.frame(matrix(ncol = 6, nrow = 0))
                     
i <- 1

for(i in 1:length(filenames)){

print(i)

filename_n <- filenames[i]

print(filename_n)

annot <- str_match(filename_n,"\\s*(.*?)\\s*_annot")[2]

chip <- str_match(filename_n, "[.]\\s*(.*?)\\s*.fisher")[2]

#fisherdata <- readLines(paste("./fisher/",filename_n,sep=""))
fisherdata <- readLines(paste("./fisher_promoters/",filename_n,sep=""))
#fisherdata <- readLines(paste("./fisher/",filename_n,sep=""))

dat <- as.data.frame(rbind(fisherdata[9],fisherdata[10])) %>%
  mutate(left = as.numeric(stri_extract_first_regex(V1, "[0-9]+")),
         right = as.numeric(stri_extract_last_regex(V1, "[0-9]+"))) %>%
  dplyr::select(-V1)

rownames(dat) <- c("top","bottom")

#dat <- as.data.frame(matrix(nrow=2,ncol=2,c(22188,604811928,0,0)))

cont <- chisq.test(dat)$expected

test <- fisher.test(dat)

pvalue <- ifelse(round(test$p.value,20)<=0.05,"*","")

rbinder <- cbind(filename_n,annot,chip,round(cont[1,1],0),dat[1,1],pvalue)

header <- rbind(header,rbinder)}

colnames(header) <- c("filename","annot","chip","expected","observed","pvalue")

chromatindat <- header %>%
  mutate(order = ifelse(annot == "allTUCR",1,
         ifelse(annot == "exonic",2,
         ifelse(annot == "exonic_intronic",3,
         ifelse(annot == "intronic",4,
         ifelse(annot == "intergenic",5,
         ifelse(annot == "coding",6,
         ifelse(annot == "lncRNA",7,
         ifelse(annot == "antisense",8,
         ifelse(annot == "misc_RNA",9,
         ifelse(annot == "randomTUCR",10,
         ifelse(annot == "TUCR_500",11,
         ifelse(annot == "TUCR_500_shuffled",12,
         ifelse(annot == "TUCR_3000",13,
         ifelse(annot == "TUCR_3000_shuffled",14,NA))))))))))))))) %>%
  gather(key = "test", value = "value",-filename,-annot,-chip,-pvalue,-order) %>%
  mutate(pvalue = ifelse(test == "observed",pvalue,""),
         fillcolor = ifelse(test == "expected",paper_red2,paper_turq)) %>%
  arrange(order,test)

chromatindat$chip <- factor(chromatindat$chip,      # Reordering group factor levels
                         levels = c("pol2", "h3k4me3","ATAC","enhancers","h3k27ac"))

chromatindat$test <- factor(chromatindat$test,      # Reordering group factor levels
                         levels = c("expected","observed"))

chromatindat$fillcolor <- factor(chromatindat$fillcolor,      # Reordering group factor levels
                         levels = c(paper_red2,paper_turq))

chromatindat$annot <- factor(chromatindat$annot,      # Reordering group factor levels
                         levels = reorder(unique(chromatindat $annot),unique(chromatindat $order)))

chromatindat <- chromatindat  %>% 
  mutate(label_positions = as.numeric(value)+(as.numeric(value)*.05))
  

  p <- ggplot(chromatindat, aes(x=chip,y=as.numeric(value),fill=test))   +
  geom_bar(stat="identity", 
           #color = "black",
           width=0.7,position="dodge") +
  #geom_errorbar(aes(ymax=as.numeric(as.character(errorbar)), ymin=as.numeric(as.character(foldchange))), width=.2,
  #               position=position_dodge(.9)) +
  geom_text(data=chromatindat,aes(x=chip,y=as.numeric(label_positions),label = pvalue), position = position_dodge(width=0.8),color = "black",size = 15) +
  #scale_fill_identity(guide = 'legend', breaks = levels(chromatindat$test)) +
  #scale_fill_brewer(palette = "Spectral") +
  scale_fill_manual(values = c(paper_red2,paper_turq)) +
  #scale_y_continuous(expand=expansion(mult=c(0,0.15))) +
  #geom_text(
  #  aes(label=round(value,2)), 
  #  vjust=1.6, 
  #  color="black", 
  #  size=rel(4))                                                      #+ 
  #ggtitle(paste("TUCRs are enriched for \n RNA Pol.II, H3K4me3,"))  + 
  xlab("Spatial Relationship")                                           + 
  ylab("Number of overlaps")                                           +
  #ggtitle(annot) +
  theme(
    #plot.title = element_text(
    #  size=rel(1.5), 
    #  face="bold",hjust = 0.5),
    #plot.title = element_text(
    #  size = rel(1.5),hjust=0.5, 
    #  face="bold"),
    strip.background = element_rect(fill="white"),
    plot.title = element_text(size=rel(3.0), face="bold",hjust = 0.5),
    axis.title = element_text(size = rel(3.0), face="bold"),
    axis.text = element_text(size = rel(2.0),angle = -90),
    strip.text = element_text(size = rel(3.0), face="bold"),
    legend.title = element_blank(),
    legend.position = "top",
    legend.text = element_text(size = rel(4.0)),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")) +
    facet_wrap(~annot, scales = "free",ncol=5)

ggsave(
    #file=paste(outputdir,"/",disease,"_tucr_lncRNAs.png",sep=""),
    file=paste(outputdir,"/SpatialRelations/",disease,"_all_spatialrelations.png",sep=""),
    plot = print(p),
    width = 25, 
    height = 15, 
    dpi = 300) 

#chromatindat2 <- chromatindat %>%
#  filter(annot == "allTUCR" | annot == "randomTUCR")

chromatindat2 <- chromatindat %>%
  filter(annot == "allTUCR" | annot == "randomTUCR")

  p2 <- ggplot(chromatindat2, aes(x=chip,y=as.numeric(value),fill=test))   +
  geom_bar(stat="identity", 
           #color = "black",
           width=0.7,position="dodge") +
  #geom_errorbar(aes(ymax=as.numeric(as.character(errorbar)), ymin=as.numeric(as.character(foldchange))), width=.2,
  #               position=position_dodge(.9)) +
  geom_text(data=chromatindat2,aes(x=chip,y=as.numeric(label_positions),label = pvalue), position = position_dodge(width=0.8),color = "black",size = 15) +
  #scale_fill_identity(guide = 'legend', breaks = levels(chromatindat$test)) +
  #scale_fill_brewer(palette = "Spectral") +
  ylim(NA,225) +
  scale_fill_manual(values = c(paper_red2,paper_turq)) +
  #scale_y_continuous(expand=expansion(mult=c(0,0.15))) +
  #geom_text(
  #  aes(label=round(value,2)), 
  #  vjust=1.6, 
  #  color="black", 
  #  size=rel(4))                                                      #+ 
  #ggtitle(paste("TUCRs are enriched for \n RNA Pol.II, H3K4me3,"))  + 
  xlab("Spatial Relationship")                                           + 
  ylab("Number of overlaps")                                           +
  #ggtitle(annot) +
  theme(
    #plot.title = element_text(
    #  size=rel(1.5), 
    #  face="bold",hjust = 0.5),
    #plot.title = element_text(
    #  size = rel(1.5),hjust=0.5, 
    #  face="bold"),
    strip.background = element_rect(fill="white"),
    plot.title = element_text(size=rel(3.0), face="bold",hjust = 0.5),
    axis.title = element_text(size = rel(3.0), face="bold"),
    axis.text.x = element_text(size = rel(3.0),angle = 90),
    axis.text.y = element_text(size = rel(3.0)),
    strip.text = element_text(size = rel(3.0), face="bold"),
    legend.title = element_blank(),
    legend.position = "top",
    legend.text = element_text(size = rel(4.0)),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")) +
    facet_wrap(~annot, scales = "free",ncol=5)
  
  p2

ggsave(
    #file=paste(outputdir,"/",disease,"_tucr_lncRNAs.png",sep=""),
    file=paste(outputdir,"/SpatialRelations/",disease,"_spatialrelations_tucronly.png",sep=""),
    plot = print(p2),
    width = 12, 
    height = 8, 
    dpi = 300) 

```

# Section 2: TUCRs are deregulated in GBM and LGG tumors

## Results

TUCR expression has not been characterized in glioblastoma (GBM) or low-grade gliomas (LGG).  We performed the first comprehensive bioinformatic analysis of TUCR expression in these diseases by comparing GBM and LGG tumor samples from the Cancer Genome Atlas (TCGA) to their normal brain counterparts.  Of the 481 TUCRs, we identified 115 and 82 that were up- and downregulated in GBM, respectively. (Figure 3A) We also identified 58 and 91 TUCRs that were up- and downregulated in LGG. (Figure 3B) Of the 157 deregulated TUCRs in LGG, 109 were also deregulated in GBM, a 70% overlap. (Figure 3C) Intergenic TUCRs are of particular interest; they may represent markers for novel genes.  Amongst intergenic TUCRs, we identified 6 up- and 6- downregulated TUCR by a magnitude greater that 2-fold and with an FDR of 0.05 or less (Figure 3D).  We performed these same analyses in LGG and identified 3 up- and 5 downregulated TUCRs. (Figure 3E) For both disease types, uc.110 and uc.62 represented the most up- and downregulated TUCRs, respectively.

### Setup for RNA-Seq analyses

The next part of this analysis involves using bash and R scripts to identify TUCRs that are deregulated and/or correlated with survival in GBM and LGG. The GBM analyses were stored in a directory named tcga_analysis, while the LGG analyses were stored in the lgg_tcga_analysis.  The following script generates these two directories.

### Make Directories

```{bash Section2_mkdir, eval = FALSE}
## Create directory for all raw data from RNA-Seq analysis
mkdir RNASEQ-RAW

## Create directory for all processed data from RNA-Seq analysis
mkdir RNASEQ-PROCESSED

## Create directory for all TCGA analyses.
mkdir RNASEQ-PROCESSED/tcga_analysis/

## Create a subdirectory for each disease
mkdir RNASEQ-PROCESSED/tcga_analysis/GBM

mkdir RNASEQ-PROCESSED/tcga_analysis/LGG

## Create directory for all GTex analyses.
mkdir RNASEQ-PROCESSED/gtex_analysis/

## Create a subdirectory for cortex samples
mkdir RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/

```

### GTEX Processing: Download RNA-Seq Data

Profile = mkgibertjr

Manifest = file-manifest-cortexonly.json

Download-Path = ./RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/

```{r Section2_GTexManifest, eval = FALSE}

GTexManifest <- fromJSON("file-manifest-fq.json")

NeedGTex <- read.table("GTex_Cortex.txt",header=TRUE)

#GTexManifest <- GTexManifest %>%
#  mutate(SAMPID = str_remove(file_name,".Aligned.sortedByCoord.out.patched.md.bam")) %>%
#  left_join(NeedGTex, by="SAMPID")

GTexManifest <- GTexManifest %>%
  mutate(SAMPID2 = str_remove(file_name,".m6A.1.fastq.gz"),SAMPID3 = str_remove(SAMPID2,".m6A.2.fastq.gz"),SAMPID = str_remove(SAMPID3,".fastq.gz")) %>%
  dplyr::select(-SAMPID2,-SAMPID3) %>%
  left_join(NeedGTex, by="SAMPID")

GTexManifest <- GTexManifest[complete.cases(GTexManifest),]

GTexManifest <- GTexManifest %>%
  select(-SAMPID,-SMTSD)

write_json(GTexManifest,"file-manifest-cortexonly.json",pretty=TRUE)

```

```{bash Section2_GTexDownload, eval=false}

echo 'export PATH=$PATH:~/.gen3' >> ~/.bash_profile

source ~/.bash_profile

./gen3-client configure --profile=mkgibertjr --cred=credentials.json
--apiendpoint=https://gen3.theanvil.io

yes | ./gen3-client download-multiple --profile=mkgibertjr --manifest=file-manifest-cortexonly.json --download-path=./gtex_analysis/ --protocol=s3

```

### GTEX Processing: Reindex GTex BAM files

```{bash Section2_gtexindex, eval = FALSE}

# Reindex the renamed files using samtools.
for bam in $(find mkdir RNASEQ-PROCESSED/gtex_analysis/cortex/reindex -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools index $bam
done

```

We will complete the counts after processing the TCGA data in a similar fashion.

### GTEX Processing: Acquiring total reads from RNA-Seq BAM files

```{bash Section2_gtexseqdepth, eval = FALSE}

mkdir RNASEQ-PROCESSED/gtex_analysis/cortex/readcounts/

for bam in $(find RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/*.bam -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -c -F 260 $bam > $name.readcounts.txt
mv $name.readcounts.txt ./RNASEQ-PROCESSED/gtex_analysis/cortex/readcounts/
done

echo "id,counts" > RNASEQ-PROCESSED/gtex_analysis/cortex/readcounts/cortex_seqdepth_counts.csv 

for txt in $(find RNASEQ-PROCESSED/gtex_analysis/cortex/readcounts/* -name '*.txt')
do
name=$(echo $txt | awk -F ".readcounts.txt" '{print $1}')
echo $name
reads=$(head $txt)
echo "$name,$reads" >> RNASEQ-PROCESSED/gtex_analysis/cortex/readcounts/cortex_seqdepth_counts.csv 
done

```

### TCGA Processing: Download Data

```{bash Section2_GTexDownload, eval=false}

echo 'export PATH=$PATH:~/.gdc-client' >> ~/.bash_profile

source ~/.bash_profile

./gdc-client download -m ./gdc_GBM_miRNA_microarray_processed_manifest.2021-09-03.txt

gdc-client download -m gdc_manifest_e24fac38d3b19f67facb74d3efa746e08b0c82c2.txt -t gdc-user-token.2015-06-17T09-10-02-04-00.txt


```

### TCGA Processing: Extract headers from BAM files

The raw BAM files for GBM and LGG were stored in GBM-RNASEQ-RAW and LGG-RNASEQ-RAW, respectively.  Since these files are labeled with unintuitive and encrypted names, I will generate clones of each BAM file using the TCGA ID as the name instead.  This will make it easier to see which files are normal brain and which are tumors at a glance.  TCGA files are not named this way by default because there is patient information contained within the BAM files that can be identified using the TCGA ID.  Therefore, renaming the file in secure storage is preferrable.  The first step to doing this is extracting the TCGA ID from the header present in each BAM file. 

In the following series of scripts, a bash script was used to extract the header from each encrypted BAM file and generate a text file containing the full header. 

```{bash Section2_tcgaheader, eval = FALSE}
## Extract header information from GBM BAM files
# Create directory for extracted headerfiles
mkdir RNASEQ-PROCESSED/tcga_analysis/GBM/head/

# Use a for loop to cycle through BAM files and extract header before creating a 
#text file containing each BAM file's header.
for bam in $(find RNASEQ-RAW/GBM/* -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -H $bam > $name.headerids.txt
mv $name.headerids.txt ./RNASEQ-PROCESSED/tcga_analysis/GBM/head/
done

## Do the same thing for LGG
# Create directory for extracted headerfiles
mkdir RNASEQ-PROCESSED/tcga_analysis/LGG/head/

for bam in $(find RNASEQ-RAW/LGG/* -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -H $bam > $name.headerids.txt
mv $name.headerids.txt ./RNASEQ-PROCESSED/tcga_analysis/LGG/head/
done
```

### TCGA Processing: Extract TCGA patient barcodes from BAM headers

Once the headers have been extracted from each BAM file, the TCGA ID is then extracted from each header.  A master table is generated that contains the encrypted BAM file name and the new TCGA ID based named, which will be used to generate the renamed clone files in the next step.

```{bash Section2_tcgaids, eval = FALSE}
## Get new file names for BAM files using TCGA IDs from extracted header
mkdir RNASEQ-PROCESSED/tcga_analysis/GBM/ids/

mkdir RNASEQ-PROCESSED/tcga_analysis/LGG/ids/

# Initialize summary file with TCGA IDs
echo "RAWID,TCGAID" > RNASEQ-PROCESSED/tcga_analysis/GBM/ids/tcgaIDs.csv

# Extract IDs from header files
for header in $(find RNASEQ-PROCESSED/tcga_analysis/GBM/head/* -name '*headerids.txt')
do
name=$(echo $header | awk -F ".headerids.txt" '{print $1}')
name2=$(echo $name | cut -c20-)
ids1=$(awk '$1=="@RG"{print $3}' $header)
ids2=$(echo $ids1 | cut -c4-)
echo "$name2.bam,$ids2.bam"
echo "$name2.bam,$ids2.bam" > $name.tcgaid.csv
echo "$name2.bam,$ids2.bam" >> RNASEQ-PROCESSED/tcga_analysis/GBM/ids/tcgaIDs.csv
mv $name.tcgaid.csv ./RNASEQ-PROCESSED/tcga_analysis/GBM/ids/
done

## Do the same thing for LGG

# Initialize summary file with TCGA IDs
echo "RAWID,TCGAID" > RNASEQ-PROCESSED/tcga_analysis/LGG/ids/tcgaIDs.csv 

# Extract IDs from header files
for header in $(find RNASEQ-PROCESSED/tcga_analysis/LGG/head/* -name '*headerids.txt')
do
name=$(echo $header | awk -F ".headerids.txt" '{print $1}')
name2=$(echo $name | cut -c24-)
ids1=$(awk '$1=="@RG"{print $3}' $header)
ids2=$(echo $ids1 | cut -c4-)
echo "$name2.bam,$ids2.bam"
echo "$name2.bam,$ids2.bam" > $name.tcgaid.csv
echo "$name2.bam,$ids2.bam" >> RNASEQ-PROCESSED/tcga_analysis/LGG/ids/tcgaIDs.csv 
mv $name.tcgaid.csv ./RNASEQ-PROCESSED/tcga_analysis/LGG/ids/
done
```

### TCGA Processing: Reindex TCGA BAM files under new names

```{bash Section2_tcgaindex, eval = FALSE}

##Rename BAM files using TCGA ids

# Create folder for new files
mkdir RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/

# Copy BAM files into new directory with updated names
while IFS=, read orig target; do
orig2=$(find RNASEQ-RAW/GBM/* -name $orig)
echo $orig2
cp $orig2 $target
mv $target RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/
done < RNASEQ-PROCESSED/tcga_analysis/GBM/ids/tcgaIDs.csv

# Reindex the renamed files using samtools.
for bam in $(find RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/ -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools index $bam
done

## Do the same thing for LGG
# Create folder for new files
mkdir RNASEQ-PROCESSED/tcga_analysis/LGG/reindex

# Copy BAM files into new directory with updated names
while IFS=, read orig target; do
orig2=$(find RNASEQ-RAW/LGG/* -name $orig)
echo $orig2
cp $orig2 $target
mv $target RNASEQ-PROCESSED/tcga_analysis/LGG/reindex/
done < RNASEQ-PROCESSED/tcga_analysis/LGG/ids/tcgaIDs.csv

# Reindex the renamed files using samtools.
for bam in $(find RNASEQ-PROCESSED/tcga_analysis/LGG/reindex/ -name '*.bam')
do
samtools view -H TCGA-CS-4938-01B-11R-1896-07.bam > header
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools reheader header $bam > $name.rehead.bam
samtools index $name.rehead.bam
done

```

### TCGA Processing: Acquiring total reads from RNA-Seq BAM files

```{bash Section2_tcgaseqdepth, eval = FALSE}

mkdir RNASEQ-PROCESSED/tcga_analysis/GBM/readcounts/

for bam in $(find RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/*.bam -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -c -F 260 $bam > $name.readcounts.txt
mv $name.readcounts.txt ./RNASEQ-PROCESSED/tcga_analysis/GBM/readcounts/
done

echo "id,counts" > RNASEQ-PROCESSED/tcga_analysis/GBM/readcounts/GBM_seqdepth_counts.csv 

for txt in $(find RNASEQ-PROCESSED/tcga_analysis/GBM/readcounts/* -name '*.txt')
do
name=$(echo $txt | awk -F ".readcounts.txt" '{print $1}')
echo $name
reads=$(head $txt)
echo "$name,$reads" >> RNASEQ-PROCESSED/tcga_analysis/GBM/readcounts/GBM_seqdepth_counts.csv 
done

## Do the same for LGG

mkdir RNASEQ-PROCESSED/tcga_analysis/LGG/readcounts/

for bam in $(find RNASEQ-PROCESSED/tcga_analysis/LGG/reindex/*.bam -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -c -F 260 $bam > $name.readcounts.txt
mv $name.readcounts.txt ./RNASEQ-PROCESSED/tcga_analysis/LGG/readcounts/
done

echo "id,counts" > RNASEQ-PROCESSED/tcga_analysis/LGG/readcounts/LGG_seqdepth_counts.csv 

for txt in $(find RNASEQ-PROCESSED/tcga_analysis/LGG/readcounts/* -name '*.txt')
do
name=$(echo $txt | awk -F ".readcounts.txt" '{print $1}')
echo $name
reads=$(head $txt)
echo "$name,$reads" >> RNASEQ-PROCESSED/tcga_analysis/LGG/readcounts/LGG_seqdepth_counts.csv 
done

```

## Get all genes

from http://ccb.jhu.edu/chess/

```{r allgenes,eval = FALSE}

chessgenes <- read_delim("chess2.2.genes",col_names=TRUE,delim="\t") %>%
  separate(Location,into=c("chrom","location","strand"),sep=":") %>%
  separate(location,into=c("start","end"),sep="-") %>%
  dplyr::select(chrom,start,end,"id"=Gene_Name,strand,"tag"=Database,"annot"=Gene_Type) %>%
  mutate(order = as.numeric(str_remove(chrom,"chr")),start = as.numeric(start),end = as.numeric(end)) %>%
  arrange(order,start) %>%
  group_by(tag) %>%
  dplyr::mutate(row_order = row_number(), id2 = ifelse(id == "-",paste(tag,row_order,sep=""),id)) %>%
  ungroup() %>%
  dplyr::select(-id,chrom,start,end,"alias"=id2,strand,tag,annot) %>%
  dplyr::mutate(id = paste(alias,"___",chrom,":",start,"-",end,":",strand,sep="")) %>%
  dplyr::select(chrom,start,end,strand,id,alias,tag,annot)

TUCRs <- read_delim("hg38.ultraconserved.bed",col_names=TRUE,delim="\t") %>%
  dplyr::mutate(id = paste(alias,"___",chrom,":",start,"-",end,":",strand,sep="")) %>%
  dplyr::select(chrom,start,end,strand,id,alias,tag,annot)

random <- read_delim("random_hg38.ultraconserved.bed",col_names=TRUE,delim="\t") %>%
  dplyr::mutate(id = paste(alias,"___",chrom,":",start,"-",end,":",strand,sep="")) %>%
  dplyr::select(chrom,start,end,strand,id,alias,tag,annot)

allgenes <- rbind(chessgenes,TUCRs,random) %>%
  separate(chrom,into=c("chrom","extra"),sep="_") %>%
  filter(is.na(extra) & str_detect(chrom,"chr")) %>%
  dplyr::select(-extra) %>%
  write_delim("BEDFiles/allgenes.bed",col_names = FALSE,delim="\t")

```

### Generate BED files to get counts

```{r Section2_bedbreaker,eval = FALSE}

if(!dir.exists("BEDFiles")){dir.create("BEDFiles")}

if(makeBEDs == TRUE){
bedbreaker <- function(file){  

bed <- read.table(file)
chrom <- unique(as.vector(bed$V1))
i <- 1

for(i in 1:length(chrom)){
  x <- bed %>%
    filter(V1 == chrom[i]) %>%
    write.table(paste("BEDFiles/",paste("chr",i,sep=""),"_genes.bed",sep=""),quote = F,col.names = F,row.names = F,sep = '\t')
}}

bedbreaker("BEDFiles/allgenes.bed")
}

## MOVE these files to the RNASEQ-PROCESSED directory in the next step

#df <- read.table("BEDFiles/chr1_genes.bed")

#alltables <- split(df, (seq(nrow(df))-1) %/% 1000)

#chr <- as.character(df$V1[1])

#N <- names(alltables)
#for (i in seq_along(N)) write_delim(alltables[[i]], file=paste0("BEDFiles/",chr,"_",N[i],"_genes.bed"),delim="\t",col_names = FALSE)

```

## Example of parallelized slurm script to process multiple inputs

```{bash, eval = FALSE}

#!/bin/bash
#SBATCH --nodes=1  --ntasks-per-node=1 --cpus-per-task=1
#SBATCH --job-name array_cortex_process
#SBATCH --time=7-0:00:00     	#amount of time for the whole job
#SBATCH --partition=standard  	#the queue/partition to run on
#SBATCH --account=abounaderlab 	#the account/allocation to use


echo "All jobs in this array have:"
echo "- SLURM_ARRAY_JOB_ID=${SLURM_ARRAY_JOB_ID}"
echo "- SLURM_ARRAY_TASK_COUNT=${SLURM_ARRAY_TASK_COUNT}"
echo "- SLURM_ARRAY_TASK_MIN=${SLURM_ARRAY_TASK_MIN}"
echo "- SLURM_ARRAY_TASK_MAX=${SLURM_ARRAY_TASK_MAX}"
 
echo "This job in the array has:"
echo "- SLURM_JOB_ID=${SLURM_JOB_ID}"
echo "- SLURM_ARRAY_TASK_ID=${SLURM_ARRAY_TASK_ID}"

# select our filename
N=${SLURM_ARRAY_TASK_ID}
# Comment one of the following two lines, depending on if the filenames have
# leading zeros
FILENAME=./BEDFiles/chr${N}_genes.bed # without leading zeros
CHROM=chr${N}

echo "My input file is ${FILENAME}"

module load gcc/9.2.0
module load bedtools/2.29.2
module load samtools/1.12

# Making directory
mkdir RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2

echo -e chrom"\t"start"\t"end"\t"strand"\t"id"\t"tag"\t"annot RNASEQ-PROCESSED/gtex_analysis/GBM/reindex/*bam | sed -e "s/ /\t/g" > RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_$CHROM.counts.txt

multiBamCov -bams RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/*bam -bed ${FILENAME} -q 10 >> RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_$CHROM.counts.txt

```

### Move BED Files to RNASEQ-PROCESSED Directory

```{bash Section2_mkdir_BEDFiles,eval = FALSE}

mkdir RNASEQ-PROCESSED/BEDFiles

```

### GTEX Processing: Generating count tables for survival and differential expression.

```{bash Section2_gtexcounts, eval = FALSE}
# Making directory
mkdir RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange

for bed in $(find RNASEQ-PROCESSED/BEDFiles/ -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
name2=$(basename -- $name)
echo $name2

if test -f $name2.counts.txt; then

echo "$name2.counts.txt exists."

else

echo -e chrom"\t"start"\t"end"\t"strand"\t"id"\t"tag"\t"annot RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/*bam | sed -e "s/ /\t/g" > RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/$name2.counts.txt

multiBamCov -bams RNASEQ-PROCESSED/gtex_analysis/cortex/reindex/*bam -bed $bed -q 10 >> RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/$name2.counts.txt

fi
done

head -1 RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/chr10_genes.counts.txt > RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/cortex_mergedcounts.txt; tail -n +2 -q RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/*.counts.txt >> RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange/cortex_mergedcounts.txt

```

### TCGA Processing: Generating count tables for survival and differential expression.

```{bash Section2_gtexcounts, eval = FALSE}
# Making directory
mkdir RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange

for bed in $(find RNASEQ-PROCESSED/BEDFiles/ -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
name2=$(basename -- $name)
echo $name2

if test -f $name2.counts.txt; then

echo "$name2.counts.txt exists."

else

echo -e chrom"\t"start"\t"end"\t"strand"\t"id"\t"tag"\t"annot RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/*bam | sed -e "s/ /\t/g" > RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/GBM_mergedcounts.txt$name2.counts.txt

multiBamCov -bams RNASEQ-PROCESSED/tcga_analysis/GBM/reindex/*bam -bed $bed -q 10 >> RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/$name2.counts.txt

fi
done

head -1 RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/chr10_genes.counts.txt > RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/GBM_mergedcounts.txt; tail -n +2 -q RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/*.counts.txt >> RNASEQ-PROCESSED/tcga_analysis/GBM/foldchange/GBM_mergedcounts.txt

 ###NEEWWWWWWWWW 
head -1 RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_chr10.counts.txt > RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_mergedcounts.txt; tail -n +2 -q RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_chr*.counts.txt >> RNASEQ-PROCESSED/gtex_analysis/cortex/foldchange2/cortex_mergedcounts.txt

# Making directory
mkdir RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange

for bed in $(find RNASEQ-PROCESSED/BEDFiles/ -name '*.bed')
do

name=$(echo $bed | awk -F ".bed" '{print $1}')
name2=$(basename -- $name)
echo $name2

if test -f $name2.counts.txt; then

echo "$name2.counts.txt exists."

else

echo -e chrom"\t"start"\t"end"\t"strand"\t"id"\t"tag"\t"annot RNASEQ-PROCESSED/tcga_analysis/LGG/reindex/*bam | sed -e "s/ /\t/g" > RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/$name2.counts.txt

multiBamCov -bams RNASEQ-PROCESSED/tcga_analysis/LGG/reindex/*bam -bed $bed -q 10 >> RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/$name2.counts.txt

fi
done

head -1 RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/LGG_chr10_genes.counts.txt > RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/LGG_mergedcounts.txt; tail -n +2 -q RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/*_counts.txt >> RNASEQ-PROCESSED/tcga_analysis/LGG/foldchange/LGG_mergedcounts.txt

```

### Identifying differentially expressed TUCRs with DESeq2

```{r Section2_DESeq2_TUCRs_continued}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis",sep=""))
}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",sep=""))
}

if(!is.na(filterannot)){
  mergedcounts <- mergedcounts %>%
    filter(tag.x == filterannot & annot.x != "random")
}

mergedcounts2 <- 
  mergedcounts[,9:ncol(mergedcounts)]

rownames(mergedcounts2) <- 
  mergedcounts$id

mergedcounts.info <- 
  mergedcounts[,1:8]

mergedcounts.info$length <- 
  (mergedcounts$end.x - mergedcounts$start.x)/1000
  
write_delim(as.data.frame(mergedcounts.info),paste(outputdir,"/mergedcounts.info.bed",sep=""),col_names = TRUE,delim="\t")

#mergedcounts <- 
#  cbind(mergedcounts.info,mergedcounts2)

#write.csv(mergedcounts2,"mergedcounts2.csv")

dds <- 
  DESeqDataSetFromMatrix(countData = mergedcounts2,
                              colData = metadata,
                              design = ~dex)
  
dds_2 <- 
  DESeq(dds)

res <- 
  results(dds_2, tidy=TRUE)

res <- 
  as_tibble(res)

if(!is.na(filterannot) & filterannot != ""){
write_csv(res, file = paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_results_",filterannot,".csv",sep=""))}else{
write_csv(res, file = paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_results_allgenes.csv",sep=""))
}

#res_summary <- res_TUCR %>%
#  mutate(dereg = 
#           ifelse(res$log2FoldChange >=1, "upregulated",
#                    ifelse(res$log2FoldChange <=-1,"downregulated","unchanged"))) %>%
#  filter(dereg == "upregulated" | dereg == "downregulated") %>%
#  group_by(dereg) %>%
#  dplyr::summarise(n = n()) %>%
#  mutate(count = ifelse(dereg=="downregulated",-n,n))

```

### Determining sequencing depth for TCGA files

```{bash Section3_seqdepth, eval = FALSE}
mkdir tcga_analysis/readcounts/

for bam in $(find tcga_analysis/reindex/*.bam -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -c -F 260 $bam > $name.readcounts.txt
mv $name.readcounts.txt ./tcga_analysis/readcounts/
done

##Do the same for lgg

mkdir lgg_tcga_analysis/readcounts/

for bam in $(find lgg_tcga_analysis/reindex/*.bam -name '*.bam')
do
name=$(echo $bam | awk -F ".bam" '{print $1}')
echo $name
samtools view -c -F 260 $bam > $name.readcounts.txt
mv $name.readcounts.txt ./lgg_tcga_analysis/readcounts/
done


```

### Identifying and comparing TUCR absolute expression in GBM and LGG

```{r Section2_RPKM_TUCRs}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis",sep=""))
}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",sep=""))
}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",sep=""))
}


if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",sep=""))
}

#if(!is.na(filterannot)){
#  rpkmcounts <- mergedcounts %>%
#  filter(tag.x == filterannot) %>%
#  mutate(length = end.x - start.x)
#}else{
rpkmcounts <- mergedcounts %>%
  mutate(length = end.x - start.x)#}

rpkmcounts.info <- rpkmcounts %>%
  dplyr::select("chrom" = chrom.x,"start" = start.x,"end" = end.x,"strand"=strand.x,id,"alias"=alias.x,"tag"=tag.x,"annot" = annot.x,length)

rpkmcounts <- rpkmcounts %>%
  dplyr::select(-chrom.x,-start.x,-end.x,-id,-strand.x,-tag.x,-annot.x,-alias.x)
  
rownames(rpkmcounts) <- as.character(rpkmcounts.info$id)

genelength <- rpkmcounts.info$length/1000

seqdepth2 <- as.vector(seqdepth$counts)/1000000

rpkm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- counts/len
  return(t(t(x)/(dep)))
}

tpm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- t(counts)/(len)
  return(t(x/dep))
}

#if(RPKmethod == "tpm" | RPKmethod == "TPM"){
#rpkm.df <- tpm(rpkmcounts,genelength,seqdepth2)  
#}else{
rpkm.df <- rpkm(rpkmcounts,genelength,seqdepth2)  
#}

rpkm.df2 <- cbind(rpkmcounts.info,rpkm.df)

rpkm.median <- as.data.frame(rpkm.df)
rpkm.median <- rpkm.median %>% 
  dplyr::summarize(median_RPKM = rowMedians(rpkm.df)) %>%
  dplyr::mutate(countif = ifelse(median_RPKM >=1,1,0),proportion = sum(countif,na.rm = TRUE)/n())
rpkm.median <- cbind(rpkmcounts.info,rpkm.median)
rpkm.median <- rpkm.median %>% dplyr::select(id,median_RPKM,countif,proportion)

proportion.df <- round(as.numeric(rpkm.median$proportion[1]),3)*100

write.csv(rpkm.df2,paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",disease,"_rpkm_allTUCRs.csv",sep=""))

write.csv(rpkm.median,paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",disease,"_medianrpkm_allTUCRs.csv",sep=""))

heatmap.df <- as.data.frame(rpkm.df) %>%
  dplyr::select(-length)
geneids <- rpkm.df2 %>%
  dplyr::select(id)
annotids <- rpkm.df2 %>%
  dplyr::select(annot)
#means <- apply(heatmap.df,1,mean)
means <- apply(heatmap.df,1,median)

heatmap.df2 <- as.data.frame(apply(heatmap.df,1:2,function(x) {ifelse(x>=10,10,x)}))
heatmap.df2 <- cbind(geneids,means,annotids,heatmap.df2)

heatmap.df2 <- heatmap.df2 %>% 
  gather(key = "Sample", value = "RPKM",-id,-means,-annot)

heatmap.df2$annot <- factor(heatmap.df2$annot,      # Reordering group factor levels
                         levels = c("protein_coding","lncRNA","antisense_RNA","misc_RNA","exonic","exonic_intronic","intronic","intergenic","random"))

p <- ggplot(data = heatmap.df2,mapping = aes(x = Sample,y = reorder(id,means), fill = RPKM)) +
  geom_tile() +
  #geom_boxplot() +
  scale_fill_gradientn(colours = c(paper_blue, "white",paper_red2), values = c(0,0.1,1)) + 
  #ggtitle(paste("All TUCRs (",proportion.df,"%)",sep="")) + xlab(paste("Samples (n = ",ncol(heatmap.df),")",sep="")) + 
  ylab(paste("genes (n = ",nrow(heatmap.df),")",sep="")) +
  theme(plot.title = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_text(size=rel(1.5))) + 
  facet_wrap(~annot,scales="free",ncol=9)



ggsave(p,file=paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_allTUCRs_heatmap.png",sep=""), width = 20, height = 5, dpi = 300)

rpkm.TUCRs2 <- rpkm.df2
  write.csv(rpkm.TUCRs2,paste(outputdir,"/ExpressionAnalysis/",disease,"_rpkm_TUCRs2.csv",sep=""))
  
heatmap.df.all <- heatmap.df2 %>%
  mutate(tag = paste("All TUCRs (",proportion.df,"%)",sep=""),Order=6)

i <- 1

for(i in 1:length(unique(mergedcounts$annot))){
  
annot_unique <- as.character(unique(mergedcounts$annot))

annotation <- as.character(annot_unique[i])

print(i)
print(annotation)
    
rpkmcounts <- mergedcounts %>%
  filter(annot.x == annotation) %>%
  mutate(length = end.x - start.x)

#rpkmcounts <- rpkmcounts[481,]

rpkmcounts.info <- rpkmcounts %>%
  dplyr::select("chrom" = chrom.x,"start" = start.x,"end" = end.x,"strand"=strand.x,id,"alias"=alias.x,"tag"=tag.x,"annot" = annot.x,length)

rpkmcounts <- rpkmcounts %>%
  dplyr::select(-chrom.x,-start.x,-end.x,-id,-strand.x,-tag.x,-annot.x,-alias.x)
  
#sum(is.na(mergedcounts$annot))
  
rownames(rpkmcounts) <- as.character(rpkmcounts.info$id)

genelength <- rpkmcounts.info$length/1000

seqdepth2 <- as.vector(seqdepth$counts)/1000000

rpkm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- counts/len
  return(t(t(x)/(dep)))
}

tpm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- t(counts)/(len)
  return(t(x/dep))
}

rpkm.df <- rpkm(rpkmcounts,genelength,seqdepth2)

#rpkm.df <- tpm(rpkmcounts,genelength,seqdepth2) 

rpkm.df2 <- cbind(rpkmcounts.info,rpkm.df)

rpkm.median <- as.data.frame(rpkm.df)
rpkm.median <- rpkm.median %>% 
  dplyr::summarize(median_RPKM = rowMedians(rpkm.df)) %>%
  dplyr::mutate(countif = ifelse(median_RPKM >=1,1,0),proportion = sum(countif,na.rm = TRUE)/n())
rpkm.median <- cbind(rpkmcounts.info,rpkm.median)
rpkm.median <- rpkm.median %>% dplyr::select(id,median_RPKM,countif,proportion)

proportion.df <- round(as.numeric(rpkm.median$proportion[i]),3)*100

#write.csv(rpkm.df2,paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",disease,"_rpkm_",annotation,".csv",sep=""))

write.csv(rpkm.median,paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",disease,"_medianrpkm_",annotation,".csv",sep=""))

heatmap.df <- as.data.frame(rpkm.df) %>%
  dplyr::select(-length)
geneids <- rpkm.df2 %>%
  dplyr::select(id)

annot <- rpkm.df2 %>%
  dplyr::select(annot)
#means <- apply(heatmap.df,1,mean)
means <- apply(heatmap.df,1,median)

heatmap.df2 <- as.data.frame(apply(heatmap.df,1:2,function(x) {ifelse(x>=10,10,x)}))
heatmap.df2 <- cbind(geneids,annot,means,heatmap.df2)

heatmap.df2 <- heatmap.df2 %>% 
  gather(key = "Sample", value = "RPKM",-id,-means,-annot)

if(file.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_",annotation,"_heatmap.png",sep=""))){}else{

p <- ggplot(data = heatmap.df2,mapping = aes(x = Sample,y = reorder(id,means), fill = RPKM)) +
  #geom_tile() +
  geom_boxplot() +
  #scale_fill_gradientn(colours = c(paper_blue, "white", paper_red2), values = c(0,0.1,1)) +
  ggtitle(paste(annotation," (",proportion.df,"%)",sep="")) + xlab(paste("Samples (n = ",ncol(heatmap.df),")",sep="")) + ylab(paste("genes (n = ",nrow(heatmap.df),")",sep="")) +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  facet_wrap(~annot,scales="free")

ggsave(p,file=paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_",annotation,"_heatmap.png",sep=""), width = 15, height = 5, dpi = 300)}

heatmap.df.add <- heatmap.df2 %>%
  mutate(tag = paste(annotation," (",proportion.df,"%)",sep=""),
         Order = ifelse(annotation == "protein_coding",1,
                        ifelse(annotation == "lncRNA",2,
                        ifelse(annotation == "antisense_RNA",3,
                        ifelse(annotation == "misc_RNA",4,
                        ifelse(annotation == "random",5,
                        ifelse(annotation == "exonic",7,
                               ifelse(annotation == "exonic_intronic",8,
                               ifelse(annotation == "intronic",9,
                               ifelse(annotation == "intergenic",10,"ERROR"
                        ))))))))))

heatmap.df.all <- rbind(heatmap.df.all,heatmap.df.add)

}



p <- ggplot(data = heatmap.df.all,mapping = aes(x = Sample,y = reorder(id,means), fill = RPKM)) +
  #geom_tile() +
  geom_boxplot() +
  #scale_fill_gradientn(colours = c(paper_blue, "white",paper_red2), values = c(0,0.1,1)) + 
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid = element_blank(),
        axis.title=element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_text(size=rel(1.0),face="bold"),
        legend.text = element_text(size=rel(2.0)),
        legend.title = element_text(size=rel(2.0),face="bold")) +
  facet_wrap(~reorder(tag,Order),scales="free",ncol=10)

if(file.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_bigheatmap.png",sep=""))){}else{ggsave(p,file=paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_bigheatmap.png",sep=""), width = 25, height = 7, dpi = 300)}

```

```{r Section2_RPKM_TUCRs}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis",sep=""))
}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",sep=""))
}

if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",sep=""))
}


if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",sep=""))
}

rpkmcounts <- mergedcounts %>%
  mutate(length = end.x - start.x)

rpkmcounts.info <- rpkmcounts %>%
  dplyr::select("chrom" = chrom.x,"start" = start.x,"end" = end.x,"strand"=strand.x,id,"alias"=alias.x,"tag"=tag.x,"annot" = annot.x,length)

rpkmcounts <- rpkmcounts %>%
  dplyr::select(-chrom.x,-start.x,-end.x,-id,-strand.x,-tag.x,-annot.x,-alias.x)
  
rownames(rpkmcounts) <- as.character(rpkmcounts.info$id)

genelength <- rpkmcounts.info$length/1000

seqdepth2 <- as.vector(seqdepth$counts)/1000000

rpkm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- counts/len
  return(t(t(x)/(dep)))
}

tpm <- function(counts,len,dep){
  #x <- rpkmcounts/genelength
  #x2 <- t(t(x)/(seqdepth2))
  x <- t(counts)/(len)
  return(t(x/dep))
}

#if(RPKmethod == "tpm" | RPKmethod == "TPM"){
#rpkm.df <- tpm(rpkmcounts,genelength,seqdepth2)  
#}else{
rpkm.df <- rpkm(rpkmcounts,genelength,seqdepth2)  
#}

rpkm.df2 <- cbind(rpkmcounts.info,rpkm.df)

rpkm.median <- as.data.frame(rpkm.df)
rpkm.median <- rpkm.median %>% 
  dplyr::summarize(median_RPKM = rowMedians(rpkm.df)) %>%
  dplyr::mutate(countif = ifelse(median_RPKM >=1,1,0),proportion = sum(countif,na.rm = TRUE)/n())
rpkm.median <- cbind(rpkmcounts.info,rpkm.median)
rpkm.median <- rpkm.median %>% dplyr::select(id,median_RPKM,countif,proportion)

proportion.df <- round(as.numeric(rpkm.median$proportion[1]),3)*100

write.csv(rpkm.df2,paste(outputdir,"/ExpressionAnalysis/RPKM_allresults/",disease,"_rpkm_allTUCRs.csv",sep=""))

write.csv(rpkm.median,paste(outputdir,"/ExpressionAnalysis/RPKM_medianonly/",disease,"_medianrpkm_allTUCRs.csv",sep=""))

heatmap.df2 <- rpkm.df2 %>%
  dplyr::select(-chrom,-start,-end,-strand,-tag,-length)

heatmap.df2 <- heatmap.df2 %>% 
  gather(key = "Sample", value = "RPKM",-id,-alias,-annot)

p<- ggplot(heatmap.df2, aes(x=annot, y=RPKM)) +
  geom_boxplot(outlier.shape=NA) +
  scale_y_continuous(limits = quantile(heatmap.df2$RPKM,c(0.1,0.9))) +
  #geom_violin(trim = FALSE)+
  #geom_point(pch=21, size=1.5) +
  #geom_jitter(binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  #ggtitle(paste(RPKmethod," expression of ",TUCR)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.6), face="bold"),
        axis.text.y = element_text(size = rel(2.2)),
        axis.text.x = element_text(size = rel(2.2),angle=90,vjust = 0.5, hjust=1),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
        labs(y=paste(ifelse((RPKmethod=="tpm"|RPKmethod=="TPM"),
                      "Transcripts per kilobase million (TPM)",
                      "Reads per kilobase million (RPKM)")),
        x = "Sample",title=disease) +
  facet_wrap(~annot,scales="free")
  #stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)

ggsave(p,file=paste(outputdir,"/ExpressionAnalysis/RPKM_heatmaps/",disease,"_rpkm_boxplot.png",sep = ""),height=10,width=20)

```

### Generate RPKM Box Plots for each TUCR

```{r Section2_boxplot_TUCRs}

if(makeRPKboxplots == TRUE){
  
if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/RPKboxplots",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/RPKboxplots",sep=""))
}
  
if(!is.na(filterannot)){
  rpkmcounts <- mergedcounts %>%
  filter(tag.x == filterannot & annot.x != "random") %>%
  mutate(length = end.x - start.x)
}else{
rpkmcounts <- mergedcounts %>%
  mutate(length = end.x - start.x)}

rpkmcounts.info <- rpkmcounts %>%
  dplyr::select("chrom" = chrom.x,"start" = start.x,"end" = end.x,"strand"=strand.x,id,"alias"=alias.x,"tag"=tag.x,"annot" = annot.x,length)

rpkmcounts <- rpkmcounts %>%
  dplyr::select(-chrom.x,-start.x,-end.x,-id,-strand.x,-tag.x,-annot.x,-alias.x)
  
rownames(rpkmcounts) <- as.character(rpkmcounts.info$id)
  
rpkm.TUCRs2 <- read.csv(paste(outputdir,"/ExpressionAnalysis/",disease,"_rpkm_TUCRs2.csv",sep=""),header=TRUE) %>%
  dplyr::select(-X) %>%
  filter(annot != "random")
  
rpkm.dotplot <- rpkm.TUCRs2[,9:ncol(rpkm.TUCRs2)]
TUCRids <- as.character(rpkm.TUCRs2$id)
annot <- as.character(rpkm.TUCRs2$annot)
length <- as.character(rpkm.TUCRs2$length)
rpkm.dotplot <- cbind(TUCRids,annot,length,rpkm.dotplot)
rpkm.dotplot <- rpkm.dotplot %>% 
  gather(key = "Sample", value = "RPKM",-TUCRids,-annot,-length) %>%
  mutate(Key = gsub("[.]","-",Sample)) %>%
    mutate(string = ifelse(str_detect(Key,"TCGA"),
                           sub(".*TCGA", "", Key),
                           sub(".*GTEX", "", Key)),
           barcode = ifelse(str_detect(Key,"TCGA"),
                            tolower(paste("TCGA",substr(string, 1, 8),sep="")),
                            tolower(paste("GTEX",substr(string, 1, 20),sep="")))) %>%
  left_join(metadata,by="barcode")

rpkm.dotplot <- rpkm.dotplot[complete.cases(rpkm.dotplot),]

median(rpkm.dotplot$RPKM,na.rm=TRUE)

i <- 255
for(i in 1:length(TUCRids)){
#TUCR <- "uc.110"
TUCR <- rpkm.TUCRs2$id[i]
TUCRname <- rpkm.TUCRs2$alias[i]
print(i)
print(TUCRname)
if(file.exists(paste(outputdir,"/ExpressionAnalysis/RPKboxplots/",disease,"_",TUCRname,"_rpkm_boxplot.png",sep = ""))){}else{
rpkm.dotplot2 <- rpkm.dotplot %>% dplyr::filter(TUCRids == TUCR)

p<- ggplot(rpkm.dotplot2, aes(x=dex, y=RPKM)) +
  geom_boxplot(outlier.color="white") +
  #geom_violin(trim = FALSE)+
  #geom_point(pch=21, size=1.5) +
  geom_jitter(binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  #ggtitle(paste(RPKmethod," expression of ",TUCR)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.6), face="bold"),
        axis.text.y = element_text(size = rel(2.2)),
        axis.text.x = element_text(size = rel(2.2),angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
        labs(y=paste(ifelse((RPKmethod=="tpm"|RPKmethod=="TPM"),
                      "Transcripts per kilobase million (TPM)",
                      "Reads per kilobase million (RPKM)")),
        x = "Sample",title=disease) +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)
  

ggsave(p,file=paste(outputdir,"/ExpressionAnalysis/RPKboxplots/",disease,"_",TUCRname,"_rpkm_boxplot.png",sep = ""),height=7,width=5)}

}}

```

## Generate FC Plots for each TUCR

```{r Section2_FC Plots}

if(makeFCplots == TRUE){
if(!dir.exists(paste(outputdir,"/ExpressionAnalysis/FCplots",sep=""))){
  dir.create(paste(outputdir,"/ExpressionAnalysis/FCplots",sep=""))
}

if(!is.na(filterannot)){
  mergedcounts_trimmed <- mergedcounts %>%
  filter(tag.x == filterannot & annot.x != "random" | alias.x == "MFRP")
}

is.sequential <- function(x){
  all(abs(diff(x)) == 1)
} 

posdata <- mergedcounts_trimmed[,1:8] %>%
  dplyr::select("chrom" = chrom.x,"start" = start.x,"end" = end.x,"strand"=strand.x,id,"alias"=alias.x,"tag"=tag.x,"annot" = annot.x)

mergedcounts_trimmed <- mergedcounts_trimmed[,9:length(colnames(mergedcounts_trimmed))]

match_colnames <- match(as.character(colnames(mergedcounts_trimmed)),as.character(metadata$survid))

mergedcounts_trimmed <- as.matrix(mergedcounts_trimmed)

#variablename <- which(as.character(colnames(tablename) %in% as.character(row.names(table2name))))

n_index <- which(as.character(metadata$dex) %in% "normal")
t_index <- which(as.character(metadata$dex) %in% "tumor")

vm <- function(x){
  cond <- factor(ifelse(seq(1,dim(x)[2],1) %in% t_index, 1,  0))
  d <- model.matrix(~1+cond)
  x <- t(apply(x,1,as.numeric))
  ex <- voom(x,d,plot=F)
  return(ex$E)
}

count_vm <- vm(mergedcounts_trimmed)

colnames(count_vm) <- colnames(mergedcounts_trimmed)

#if(is.sequential(match_colnames)){
#  print("metadata rows match countfile columns")
#  colnames(count_vm) <- metadata$id
#}else{
#  "metadata rows do not match countfile columns"
#}

scal <- function(x,y){
  median_n <- rowMedians(y)  # mean of normal
  sd_n <- apply(y,1,sd)  # SD of normal
  # z score as (value - mean normal)/SD normal
  res <- matrix(nrow=nrow(x), ncol=ncol(x))
  colnames(res) <- colnames(x)
  rownames(res) <- rownames(x)
  for(i in 1:dim(x)[1]){
    for(j in 1:dim(x)[2]){
      res[i,j] <- (x[i,j]-median_n[i])/sd_n[i]
    }
  }
  return(res)
}

z_rna <- scal(count_vm,count_vm[,n_index])

rownames(z_rna) <- posdata$id

write.csv(as.data.frame(z_rna),file=paste(outputdir,"/TUCR_zscores.csv",sep=""),row.names=T)

fc_counts <- cbind(posdata,z_rna) %>%
  dplyr::select(-chrom,-start,-end,-strand)

fc.dotplot <- fc_counts %>% 
  gather(key = "Sample", value = "ZScore",-id,-alias,-tag,-annot) %>%
  mutate(Key = gsub("[.]","-",Sample)) %>%
    mutate(string = ifelse(str_detect(Key,"TCGA"),
                           sub(".*TCGA", "", Key),
                           sub(".*GTEX", "", Key)),
           barcode = ifelse(str_detect(Key,"TCGA"),
                            tolower(paste("TCGA",substr(string, 1, 8),sep="")),
                            tolower(paste("GTEX",substr(string, 1, 20),sep="")))) %>%
  left_join(metadata,by="barcode")


res_TUCR <- read_csv(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_results_",filterannot,".csv",sep="")) %>%
  dplyr::select("id.x"=row,log2FoldChange)

fc.dotplot <- fc.dotplot %>%
  left_join(res_TUCR,by="id.x") %>%
  mutate(DESeq2 = ifelse(dex=="normal",0,log2FoldChange)) %>%
  mutate(fill = ifelse(DESeq2 >= 1,paper_red,
                ifelse(DESeq2 <= -1,paper_green,paper_gray))) %>%
  dplyr::select(-Sample,-Key,-id.y,-string,-log2FoldChange) %>%
  filter(!is.na(dex))

i <- 1

for(i in 1:length(unique(fc.dotplot$id.x))){
  
filterdotplot <- as.character(unique(fc.dotplot$id.x[i]))

print(i)

fc.dotplot2 <- fc.dotplot %>%
  filter(id.x == filterdotplot)

if(file.exists(paste(outputdir,"/ExpressionAnalysis/FCplots/",disease,"_",fc.dotplot2$alias[1],"_FC_plot.png",sep = ""))){}else{

print(fc.dotplot2$alias[1])

foldchange.DESeq2 <- fc.dotplot2 %>%
  filter(dex == "tumor") %>%
  dplyr::select(DESeq2)

foldchange.DESeq2 <- round(foldchange.DESeq2[1,1],2)

fc.dotplot3 <- fc.dotplot2 %>%
  dplyr::select(dex,DESeq2,fill) %>%
  distinct()

p2 <- ggplot(data = fc.dotplot2,aes(x=dex, y=ZScore,fill=fill)) +
  geom_boxplot(outlier.color="white") +
  #geom_bar(colour="black",stat="identity") +
  scale_fill_identity() +
  #scale_color_manual(values = c("black"="black","red"="red","green"="green")) +
  geom_jitter(data = fc.dotplot2, aes(x=dex, y=ZScore),binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  ggtitle(disease) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.6), face="bold"),
        axis.text.y = element_text(size = rel(2.2)),
        axis.text.x = element_text(size = rel(2.2),angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
  labs(y="log2FoldChange", x = "Tissue Type") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)

ggsave(p2,file=paste(outputdir,"/ExpressionAnalysis/FCplots/",disease,"_",fc.dotplot2$alias[1],"_FC_plot.png",sep = ""),height=7,width=5)

if(fc.dotplot2$alias[1] == "uc.110"){
write.csv(fc.dotplot2,file=paste(outputdir,"/ExpressionAnalysis/FCplots/",disease,"_",fc.dotplot2$alias[1],"_zscoretable.csv",sep = ""))}}

}

rm(fc_counts)
rm(fc.dotplot,fc.dotplot2,fc.dotplot3)
rm(mergedcounts_trimmed)
rm(p2,z_rna,posdata)}

```

# Section 3: TUCR expression correlates with survival in LGG and GBM

## Results

Gene deregulation can sometimes result in a disparity in clinical outcomes.  We sought to identify whether deregulation of any of the 481 TUCRs correlate with patient outcomes in LGG and GBM.  For this exercise, we obtained LGG and GBM patient survival data from TCGA.  We then matched these patient outcomes to the patient RNA-Seq samples that were included in our differential expression analysis.  For each TUCR, we produced a Kaplan-Meier plot tracking differences in survival for high expressing and low expressing groups.  The high expression group represents the top quartile (25%) of expression values across the RNA-Seq samples; the low expression group represents the bottom quartile (25%) of expression values.  

Of the 310 TUCRs that were expressed in GBM TCGA RNA-Seq data, only 36 were correlated with survival in manner that was statistically significant (p-value < 0.05).  Of these 36 TUCRs, 9 had a statistically significant Cox proportional hazard that was associated with a good prognosis, while 7 had one that was associated with a poor prognosis.  The remaining 20 displayed a statistically significant difference in survival in our Kaplan-Meier analysis.  (Figure 3A)

We were initially surprised by the relatively (11.6%) small fraction of TUCRs that correlate with survival in GBM.  However, glioblastoma has a median survival of 15 months, which does not leave much room for dramatic differences in patient outcomes.  We also studied survival differences across LGG patients, as they have a much longer median survival (X months).  Because of this, we hypothesized that more TUCRs would correlate with survival in LGG.  Indeed, of the 293 TUCRs that were expressed in LGG TCGA RNA-Seq data, over half (n = 167) were correlated with survival in at least one of our studies.  Of these 167 TUCRs, 19 had a statistically significant Cox proportional hazard that was associated with a good prognosis, while 18 had one that was associated with a poor prognosis.  In this analysis, we also identified TUCRs that were statistically significant in our Cox Proportional Hazards and Kaplan Meier studies.  Of these, 49 were associated with a good prognosis while only 3 were associated with a poor prognosis.  The remaining 78 displayed a statistically significant difference in survival in our Kaplan-Meier analysis only (Figure 3B).  We have highlighted two TUCRs that represent a statistically significant correlation with good (uc.443, Figure 3C) or poor (uc.75, Figure 3D) prognosis using both methods.

## Methodology

### Acquiring and parsing clinical survival data

```{bash Section3_clindata, eval = FALSE}

wget http://gdac.broadinstitute.org/runs/stddata__2016_01_28/data/GBM/20160128/gdac.broadi
nstitute.org_GBM.Merge_Clinical.Level_1.2016012800.0.0.tar.gz

tar -xvzf gdac.broadinstitute.org_GBM.Merge_Clinical.Level_1.2016012800.0.0.tar.gz

mv gdac.broadinstitute.org_GBM.Merge_Clinical.Level_1.2016012800.0.0 GBM.Merge_Clinical

```

### Completing survival analysis for TUCRs

```{r Section3_surcor_TUCRs}

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis",sep=""))
}

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis/SummaryTables/",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis/SummaryTables/",sep=""))
}


if(!file.exists("GBM.clin.merged.txt")){unzip("GBM.clin.merged.zip")}

if(!is.na(filterannot)){
  survcounts <- mergedcounts %>%
    filter(tag.x == filterannot & annot.x != "random")
  
}else{
  survcounts <- mergedcounts
}

posdata <- survcounts[,1:8]
survcounts <- survcounts[,9:length(colnames(survcounts))]

is.sequential <- function(x){
  all(abs(diff(x)) == 1)
} 

match_colnames <- match(as.character(colnames(survcounts)),as.character(metadata$survid))

survcounts <- as.matrix(survcounts)

n_index <- which(as.character(metadata$dex) %in% "normal")
t_index <- which(as.character(metadata$dex) %in% "tumor")

vm <- function(x){
  #x <- mergedcounts
  cond <- factor(ifelse(seq(1,dim(x)[2],1) %in% t_index, 1,  0))
  d <- model.matrix(~1+cond)
  x <- t(apply(x,1,as.numeric))
  ex <- voom(x,d,plot=F)
  return(ex$E)
}

count_vm <- vm(survcounts)

if(is.sequential(match_colnames)){
  print("metadata rows match countfile columns")
  colnames(count_vm) <- metadata$id
}else{
  "metadata rows do not match countfile columns"
}



scal <- function(x,y){
  mean_n <- rowMeans(y)  # mean of normal
  sd_n <- apply(y,1,sd)  # SD of normal
  # z score as (value - mean normal)/SD normal
  res <- matrix(nrow=nrow(x), ncol=ncol(x))
  colnames(res) <- colnames(x)
  rownames(res) <- rownames(x)
  for(i in 1:dim(x)[1]){
    for(j in 1:dim(x)[2]){
      res[i,j] <- (x[i,j]-mean_n[i])/sd_n[i]
    }
  }
  return(res)
}

z_rna <- scal(count_vm[,t_index],count_vm[,n_index])
rownames(z_rna) <- posdata[,4]

clinical <- read.table("GBM.clin.merged.txt",header = TRUE)
#clinical <- read.table("GBM.oncolnc.merged.txt",header = TRUE)

clinical$time <- as.numeric(clinical$time)

clinical <- clinical %>%
  dplyr::select("barcode"=patient,time,status)

clinical2 <- metadata %>% left_join(clinical,by = "barcode")

#sum(clinical$patient %in% colnames(z_rna))

ind_tum <- which(unique(colnames(z_rna)) %in% clinical2$id)
ind_clin <- which(clinical2$id %in% colnames(z_rna))

out.tab <- c()
for(x in 1:nrow(count_vm)){
  ind_gene <- x
  s <- Surv(clinical$time[ind_clin],clinical$status[ind_clin])
  cx <- coxph(formula = s ~ z_rna[ind_gene,ind_tum])
  cx <- tidy(cx)
  out.tab <- rbind(out.tab,cx)
}

surv_TUCR <- cbind(posdata,out.tab)
surv_TUCR <- surv_TUCR %>% dplyr::select(-term)

write_csv(surv_TUCR,paste(outputdir,"/SurvivalAnalysis/SummaryTables/",disease,"_survival_TUCRs.csv",sep=""))

if(makekpmplots == TRUE){

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis/tucrKPMplots",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis/tucrKPMplots",sep=""))
}

km_countdata <- z_rna
#colnames(km_countdata) <- metadata$id
posdata$median <- rowMedians(survcounts)

km_countdata2 <- km_countdata[,complete.cases(clinical)]

probs <- c(0.25,0.5,0.75)
q <- rowQuantiles(km_countdata2, probs = probs)
posdata$n25 <- q[,1]
posdata$n75 <- q[,3]
posdata <- posdata %>%
  dplyr::select("TUCR"=alias.x,median,n25,n75)
km_TUCRs <- cbind(posdata,km_countdata[,complete.cases(clinical2)]) 

km_TUCRs <- km_TUCRs %>%
  gather(key = "id", value = "count",-TUCR,-median,-n75,-n25) %>%
  mutate(group = ifelse(count>=n75,"high",ifelse(count<=n25,"low",NA))) %>%
  distinct %>%
  dplyr::select(TUCR,median,id,group) %>%
  left_join(clinical2,by="id") %>%
  dplyr::filter(median != 0)

TUCRids <- as.character(posdata$TUCR)
i = 1

ptable <- data.frame(matrix(ncol=3,nrow=0, dimnames=list(NULL, c("TUCR","pvalue","method"))))

for(i in 1:length(TUCRids)){
  print(i)
  print(TUCRids[i])
  
  skip_to_next <- FALSE
  TUCRsurv <- as.character(TUCRids[i])
  #TUCR <- "uc.1"
  kmdata <- km_TUCRs %>%
    dplyr::filter(TUCR == TUCRsurv) %>%
    dplyr::select(TUCR,id,group,time,status) 
  fit <- tryCatch(survfit(Surv(time, status) ~ group, data = kmdata),
                error = function(e) { skip_to_next <<- TRUE})
  p <- tryCatch(ggsurvplot(fit,data=kmdata,conf.int = TRUE,pval = TRUE,risk.table = TRUE),
                error = function(e) { skip_to_next <<- TRUE})
  #p <- ggsurvplot(fit,data=kmdata,conf.int = TRUE,pval = TRUE,risk.table = TRUE)
                
  if(skip_to_next == TRUE) { 
    rbinder <- cbind(as.character(TUCRsurv),NA,NA)
    ptable[i,] <- rbinder
}else{
  grid.draw.ggsurvplot <- function(x){
  survminer:::print.ggsurvplot(x, newpage = FALSE)
}
  if(file.exists(paste(outputdir,"/SurvivalAnalysis/tucrKPMplots/",disease,"_",TUCRsurv,"_kpmplot.png",sep = ""))){}else{ggsave(file=paste(outputdir,"/SurvivalAnalysis/tucrKPMplots/",disease,"_",TUCRsurv,"_kpmplot.png",sep = ""), device="png", plot=p)}
  p2value <- surv_pvalue(fit,  data = kmdata,method = "survdiff")
  rbinder <- cbind(as.character(TUCRsurv),p2value$pval,p2value$method)
  ptable[i,] <- rbinder
}}

write_csv(ptable,paste(outputdir,"/SurvivalAnalysis/SummaryTables/",disease,"_kpm_summary_TUCRs.csv",sep=""))}

```

### Writing a script to generate a volcano plot for survival

```{r Section3_volcanosurv}

### Volcano plot

volcanosurv <- function (res,genes = "all",title = paste("TUCRs correlated with survival in ",disease,sep=""), output = paste(disease,"_results__survival_volcanoplot.png",sep=""),width = 10, height = 5, dpi = 300){
  #res <- res_surv
  #genes = c("uc.110","uc.62")
  #title = paste("TUCR correlation with patient survival in ",disease,sep="")
  #output = paste(outputdir,"/intergenic_tucr_results_volcanosurv.png",sep="")
  i <- 1
  vres <- res
  vres <- vres %>% mutate(gene="",Survival="",color="")
  for (i in 1:length(vres$id)){
  ifelse(is.na(vres$pvalue[i]),vres$pvalue[i] <- 1,vres$pvalue[i] <- vres$pvalue[i])
    
  ifelse(genes!="all",ifelse(!is.na(match(vres$id[i],genes)),vres$gene[i] <- as.character(vres$id[i]), ""),vres$gene[i] <- vres$id[i])
  
  ifelse((vres$pvalue[i] <0.05 & vres$p.value[i] <0.05 & vres$estimate[i] < 0),{vres$Survival[i] <- "Significant (Good Prognosis)";vres$color[i] <- print(paper_green);},
  ifelse((vres$pvalue[i] <0.05 & vres$p.value[i] <0.05 & vres$estimate[i] > 0),{vres$Survival[i] <- "Significant (Poor Prognosis)";vres$color[i] <- print(paper_red);},
  ifelse((vres$pvalue[i] >0.05 & vres$p.value[i] <0.05 & vres$estimate[i] < 0),{vres$Survival[i] <- "Significant (Good Prognosis)";vres$color[i] <- print(paper_green);},
  ifelse((vres$pvalue[i] >0.05 & vres$p.value[i] <0.05 & vres$estimate[i] > 0),{vres$Survival[i] <- "Significant (Poor Prognosis)";vres$color[i] <- print(paper_red);},
  ifelse((vres$pvalue[i] <0.05 & vres$p.value[i] >0.05),{vres$Survival[i] <- "Significant (KM)";vres$color[i] <- "black";},
  ifelse({vres$Survival[i] <- "Not significant";vres$color[i] <- "lightgray";}))))))}
  
  vres <- vres %>%
  arrange(desc(Survival))

  
  ## plot
if(repel==TRUE){p <- ggplot(vres) +
        geom_point(aes(x=estimate, y=-log10(as.numeric(p.value)),col=color)) +
        scale_color_identity(guide = "legend", labels = vres$Survival, breaks = vres$color) +
        ggtitle(title) +
        labs(x = "Cox Estimated Proportional Hazard",
        y = "-log10 P-Value (CH)",
        color = "Legend")+
        theme(plot.title = element_text(size = rel(1.5), hjust = 0.5, face="bold"),
              axis.title = element_text(size = rel(1.25), face="bold"),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +
        geom_text_repel(aes(x=estimate, y=-log10(as.numeric(p.value)),label = gene),force=50)
}else{
  p <- ggplot(vres) +
        geom_point(aes(x=estimate, y=-log10(as.numeric(pvalue)),col=color)) +
    scale_color_identity(guide = "legend", labels = vres$Survival, breaks = vres$color) +
        + ggtitle(title) +
        labs(x = "Cox Estimated Proportional Hazard",
        y = "-log10 P-Value (CH)",
        color = "Legend") +
        theme(plot.title = element_text(size = rel(1.5), hjust = 0.5, face="bold"),
              axis.title = element_text(size = rel(1.25), face="bold"),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))}
ggsave(output, width = width, height = height, dpi = dpi)
}

```

### Summarize Survival Data 

```{r Section3_summary surv}

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/",sep=""))
}

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",sep=""))
}

if(!dir.exists(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",sep=""))){
  dir.create(paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",sep=""))
}

genes <- ""

surv_TUCR <- read.csv(paste(outputdir,"/SurvivalAnalysis/SummaryTables/",disease,"_survival_TUCRs.csv",sep=""),header=TRUE)

ptable <- read.csv(paste(outputdir,"/SurvivalAnalysis/SummaryTables/",disease,"_kpm_summary_TUCRs.csv",sep=""),header=TRUE) %>%
  dplyr::select("id"=TUCR,pvalue,method)

colnames(ptable) <- c("alias.x","pvalue","method")

res_surv <- inner_join(ptable,surv_TUCR,by="alias.x")

res_surv_sum <- res_surv

res_surv_sum <- res_surv_sum %>% mutate(gene="",Survival="",color="")

annot_unique <- as.character(unique(res_surv_sum$annot.x))

annotation <- "All"

res_surv_sum2 <- res_surv_sum

for (i in 1:length(res_surv_sum2$alias.x)){
  #print(as.character(res_surv_sum2$alias.x[i]))
  ifelse(is.na(res_surv_sum2$pvalue[i]),res_surv_sum2$pvalue[i] <- 1,res_surv_sum2$pvalue[i] 
         <- res_surv_sum2$pvalue[i])
    
  ifelse(genes!="all",ifelse(!is.na(match(res_surv_sum2$alias.x[i],genes)),
                             res_surv_sum2$gene[i] <- as.character(res_surv_sum2$alias.x[i]), ""),
                                  res_surv_sum2$gene[i] <- res_surv_sum2$alias.x[i])
  
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] <0.05 & 
            res_surv_sum2$estimate[i] < 0),
         {res_surv_sum2$Survival[i] <- "Significant (Both, Good Prognosis)";res_surv_sum2$color[i] <- print(paper_green);},
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] > 0),
         {res_surv_sum2$Survival[i] <- "Significant (Both, Poor Prognosis)";res_surv_sum2$color[i] <- print(paper_red);},
  ifelse((res_surv_sum2$pvalue[i] >0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] < 0),
         {res_surv_sum2$Survival[i] <- "Significant (CH, Good Prognosis)";res_surv_sum2$color[i] <- print(paper_green);},
  ifelse((res_surv_sum2$pvalue[i] >0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] > 0),
         {res_surv_sum2$Survival[i] <- "Significant (CH, Poor Prognosis)";res_surv_sum2$color[i] <- print(paper_red);},
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] >0.05),
         {res_surv_sum2$Survival[i] <- "Significant (KM)";res_surv_sum2$color[i] <- "black";},
  {res_surv_sum2$Survival[i] <- "Not significant";res_surv_sum2$color[i] <- "lightgray";})))))}

res_surv_sum4 <- res_surv_sum2 %>%
  group_by(Survival) %>%
  dplyr::summarise(count = n(),color) %>%
  distinct() %>%
  arrange(desc(Survival))

write.csv(res_surv_sum4,file=paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",disease,"_",annotation,"_tucr_surv_table.csv",sep=""))

p <- ggplot(res_surv_sum4, aes(x=Survival,y=count,fill=color)) + geom_bar(stat="identity", width = 0.7) + 
  scale_fill_identity(guide = "legend", labels = res_surv_sum2$Survival, breaks = res_surv_sum2$color) + 
  labs(y = "# of TUCRs", fill = "Legend") + 
  theme(
plot.title = element_text(size=rel(1.5), face="bold",hjust = 0.5),
axis.title = element_text(size = rel(1.25), face="bold"),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
axis.text.x = element_blank())

ggsave(file=paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",disease,"_",annotation,"_tucr_surv_bar.png",sep=""),plot = print(p), width = 5, height = 2.5, dpi = 300)

res_surv_sum3 <- res_surv_sum

volcanosurv(res_surv_sum3, genes = "", title = paste(annotation," TUCR correlation with patient survival in ",disease,sep=""),output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_",annotation,"_tucr_results_volcanosurv.png",sep=""))

if(filterannot == "TUCR"){
h <- 1

for (h in 1:length(annot_unique)){
  annotation <- as.character(annot_unique[h])  
  print(annotation)
  res_surv_sum2 <- res_surv_sum %>%
    filter(annot == annotation)

for (i in 1:length(res_surv_sum2$alias.x)){
  #print(as.character(res_surv_sum2$id[i]))
  ifelse(is.na(res_surv_sum2$pvalue[i]),res_surv_sum2$pvalue[i] <- 1,res_surv_sum2$pvalue[i] 
         <- res_surv_sum2$pvalue[i])
    
  ifelse(genes!="all",ifelse(!is.na(match(res_surv_sum2$alias.x[i],genes)),
                             res_surv_sum2$gene[i] <- as.character(res_surv_sum2$alias.x[i]), ""),
                                  res_surv_sum2$gene[i] <- res_surv_sum2$alias.x[i])
  
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] <0.05 & 
            res_surv_sum2$estimate[i] < 0),
         {res_surv_sum2$Survival[i] <- "Significant (Both, Good Prognosis)";res_surv_sum2$color[i] <- print(paper_green);},
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] > 0),
         {res_surv_sum2$Survival[i] <- "Significant (Both, Poor Prognosis)";res_surv_sum2$color[i] <- print(paper_red);},
  ifelse((res_surv_sum2$pvalue[i] >0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] < 0),
         {res_surv_sum2$Survival[i] <- "Significant (CH, Good Prognosis)";res_surv_sum2$color[i] <- print(paper_green);},
  ifelse((res_surv_sum2$pvalue[i] >0.05 & res_surv_sum2$p.value[i] <0.05 &
            res_surv_sum2$estimate[i] > 0),
         {res_surv_sum2$Survival[i] <- "Significant (CH, Poor Prognosis)";res_surv_sum2$color[i] <- print(paper_red);},
  ifelse((res_surv_sum2$pvalue[i] <0.05 & res_surv_sum2$p.value[i] >0.05),
         {res_surv_sum2$Survival[i] <- "Significant (KM)";res_surv_sum2$color[i] <- "black";},
  {res_surv_sum2$Survival[i] <- "Not significant";res_surv_sum2$color[i] <- "lightgray";})))))}

res_surv_sum4 <- res_surv_sum2 %>%
  group_by(Survival) %>%
  dplyr::summarise(count = n(),color) %>%
  distinct() %>%
  arrange(desc(Survival))

write.csv(res_surv_sum4,file=paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",disease,"_",annotation,"_tucr_surv_table.csv",sep=""))

p <- ggplot(res_surv_sum4, aes(x=Survival,y=count,fill=color)) + geom_bar(stat="identity", width = 0.7) + 
  scale_fill_identity(guide = "legend", labels = res_surv_sum2$Survival, breaks = res_surv_sum2$color) + 
  labs(y = "# of TUCRs", fill = "Legend") + 
  theme(
plot.title = element_text(size=rel(1.5), face="bold",hjust = 0.5),
axis.title = element_text(size = rel(1.25), face="bold"),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
axis.text.x = element_blank())

ggsave(file=paste(outputdir,"/SurvivalAnalysis/SummaryFigures/BarGraphs/",disease,"_",annotation,"_tucr_surv_bar.png",sep=""),plot = print(p), width = 5, height = 5, dpi = 300)

volcanosurv(res_surv_sum2, genes = "", title = paste(annotation," TUCR correlation with patient survival in ",disease,sep=""),output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_",annotation,"_tucr_results_volcanosurv.png",sep=""))
}
}

```

# Section 4: TUCRs are coregulated with genes that have known functions

## Results 

Many genes have published functions and mechanisms of action.  Gene that are coregulated have correlated differential expression.  Coregulated genes may share a biological function.  We have predicted TUCR function by identifying coregulated genes with known functions.  Using a guilt-by-association analysis pipeline, we first identified determined the deregulation of all known coding and non-coding genes using the CHESS annotation database.  This dataset contains known Refseq and Ensembl genes in additional to some novel genes that were discovered in 2018.  We the constructed a correlation matrix of TUCRs to other TUCRs and “CHESS genes” using the Spearman correlation.  This correlation measures the relationship of the gene to the TUCR as TUCR deregulation decreases.  If the TUCR increases and the coregulated gene decreases, the correlation will increase and approach a perfect positive correlated value of 1.  If the TUCR increases and the coregulated gene decreases, the correlation will decrease and approach a perfect negative correlation of -1.  Genes with no correlation to the TUCR are those with a correlation close to zero, specifically between -0.3 and 0.3.  

Coregulated genes lists for each TUCR were subset into separate lists by directionality (positive/negative).  These lists were subject to gene ontology (GO) term analysis.  For each TUCR, lists of biological processes, molecular functions, or cellular compartments were predicted for the list of coregulated genes.  This list was cross referenced and filtered to a control list of “cancer” related GO Terms; these terms were generated by performing the same guilt-by-association analysis on known oncogenes and tumor suppressors from the CancerMine database.  The final matrix was filtered to statistically significant (FDR <=0.05) GO Terms only. Then a heatmap of the directionality of significant positive (red), negative (blue), and uncorrelated biological processes (white) was generated for GBM (Figure 5A) and LGG (Figure 6A).  These heatmaps were sorted by frequency of occurrence, and the 10 most represented positive (Figure 5B, Figure 6B) and negative (Figure 5C, Figure 6C) associations are highlighted.  These analyses were also performed to determine TUCR molecular functions (MF, Supplementary Figures 2 and 3) and cellular compartments (CC, Supplementary Figures 4 and 5).  The full list of all TUCR GO Terms was also compiled.  (Supplementary Table 1) 

## Methodology

Please refer to tucr_wgcna for extended details.

## Reading in PAR-CLIP data and assigning predicted miRs

The PAR-CLIP pull down method was combined with next gen sequencing to identify.

```{r parclip targets}

if(!dir.exists(paste(outputdir,"/miRAnalysis/",sep=""))){
  dir.create(paste(outputdir,"/miRAnalysis/",sep=""))
}

# read in miRNA seed information
mirnas <- read_csv("mirna-seeds.csv")
tucr_annot <- read.table("hg38.ultraconserved.bed",header=TRUE) 
colnames(tucr_annot) <- c("chrom","start","end","row","strand","tag","annot")

dds_TUCR <- read_csv(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_results_",filterannot,".csv",sep=""))

# Function to read and process PARCLIP data from Markus. Only imports chr,
# strand, start, end, annotation, gene name, cluster id, cluster sequence, and #
# reads. Filters out anything that isn't UTR or coding, and filters out hits on
# unplaced contigs (things that don't start with a named chromosome)

read_parclip <- function(geneclfile) {
clustfile <- read_csv(geneclfile, skip=1, col_types="ic___c",
col_names=c("sort","row","clustseq")) 

clustfile
}

# Function to join PARCLIP data to mirna data Does a full cartesian product
# full-join then filters individual rows based on partial match.
# See http://stackoverflow.com/a/32915578/654296 for details on how this works

join_parclip_to_mirnas <- function(parclipdata, mirnadata) {
parclipdata %>%
mutate(i=1) %>%
full_join(mutate(mirnadata, i=1), by="i") %>%
dplyr::select(-i) %>%
filter(stringr::str_detect(clustseq, revcomp)) %>%
#filter(stringr::str_detect(realclust, revcomp)) %>%
distinct()
}

# Import PARCLIP data and join to miRNAs
# load("intermediate.RData")

  pc1 <- read_parclip("TUCRclusters.csv")
  pc1 <- join_parclip_to_mirnas(pc1, mirnas)
  tucr_miRNAs <- tucr_annot %>% left_join(dds_TUCR,by="row") %>% full_join(pc1,by="row")
  write_csv(tucr_miRNAs,paste(outputdir,"/miRAnalysis/","TUCRs_mirnas.csv",sep = ""))

```

## Find likely uc.110-miR regulated genes

```{r deseq_miRs}

res <- read_csv(paste("Outputs_GBM_cortex_20240416/ExpressionAnalysis/DESeq2Results/",disease,"_results_TUCR.csv",sep="")) %>%
  #dplyr::select(-`...1`) %>%
  separate(row,c("Target gene","kibble"),sep="___")

mergedcounts_myron <- read.table("Myron_RNASEQ-20220225_mergedcounts.txt",header = TRUE)

metadata_myron  <- read_csv(file = "Myron_RNASEQ_metadata.csv")

mergedcounts2_myron <- 
  mergedcounts_myron[,9:ncol(mergedcounts_myron)]

rownames(mergedcounts2_myron) <- 
  mergedcounts_myron$id

mergedcounts_myron.info <- 
  mergedcounts_myron[,1:8]

mergedcounts_myron.info$length <- 
  (mergedcounts_myron$end - mergedcounts_myron$start)/1000

mergedcounts_myron <- 
  cbind(mergedcounts_myron.info,mergedcounts2_myron)

#write.csv(mergedcounts2,"mergedcounts2.csv")

dds_myron <- 
  DESeqDataSetFromMatrix(countData = mergedcounts2_myron,
                              colData = metadata_myron,
                              design = ~dex)
dds_myron <- 
  DESeq(dds_myron)

res_myron <- 
  results(dds_myron, tidy=TRUE)

res_myron <- 
  as_tibble(res_myron)

#res <- res %>%
#  mutate(string = str_split(row,"___"),unlist(`Target gene` = string[1]))

colnames(res_myron) <- c("Target gene","baseMean","log2FoldChange","lfcSE","stat","pvalue","padj")

res_myron <- res_myron %>%
  separate(`Target gene`,c("Target gene","kibble"),sep="___") %>%
  write_csv(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_Myron_20220225_results_allgenes.csv",sep=""))

cancermine <- read.csv("cancermine_genelist_results.csv",header=TRUE) %>%
  dplyr::select("Target gene"=target,role)

miR544 <- read_delim("TargetScan8.0__miR-544a-5p.predicted_targets.txt",col_names=TRUE,delim="\t")

res_miR544 <- res %>%
  inner_join(miR544,by="Target gene") %>%
  #left_join(cancermine,by="Target gene") %>%
  filter(abs(log2FoldChange)>=0.65) %>%
  #dplyr::select(`Target gene`,log2FoldChange,role) %>%
  dplyr::select(`Target gene`,log2FoldChange,padj) %>%
  mutate(mirna = "miR-544")

uc.110_poscor <- read_csv(paste(outputdir,"/GuiltAnalysis/correlations/positive/uc.110_plus_correlations.csv",sep="")) %>%
  separate(`...1`,c("Target gene","kibble"),sep="___") %>%
  dplyr::select("Target gene","cor")

uc.110_miRNAs <- res_miR544 %>%
  write_csv(paste(outputdir,"/uc110_miRNAs.csv",sep="")) %>%
  left_join(res_myron,by="Target gene") %>%
  dplyr::select(mirna,`Target gene`,log2FoldChange.x,padj.x,log2FoldChange.y,padj.y) %>%
  mutate(GBM_rank = percent_rank(abs(log2FoldChange.x)),
         TUC110_rank = percent_rank(abs(log2FoldChange.y)),
         sum_rank = GBM_rank + TUC110_rank) %>%
  arrange(desc(sum_rank)) %>%
  write_csv(paste(outputdir,"/miRAnalysis/","candidategenes_TUC110.csv",sep=""))

```

## Write function to plot potential TUC110-miR regulated genes

```{r plot_deseq_miRs}

### Volcano plot

volcanoplot_mirna <- function (res,
                         title = "Deregulated and coregulated uc.110 genes are predicted to be miRNA targets", 
                         output = paste(outputdir,"/miRAnalysis/miRNA_results_volcanoplot.png",sep=""),
                         output2 = paste(outputdir,"/miRAnalysis/miRNA_results_volcanoplot2.png",sep=""),
                         height = 10, 
                         width = 15, 
                         dpi = 300){
  #res <- uc.110_miRNAs
  #genes <- "all"
  #genes = c("uc.110")
  #title = "Deregulated Genes"
  #res <- res %>% 
  #  mutate(filter1 = abs(log2FoldChange)>=0.65,filter2 = pvalue <=0.05) %>%
  #  mutate(Legend = ifelse(filter1 == TRUE & filter2 == TRUE, ">1.6-Fold & <0.05 FDR",
  #                  ifelse(filter1 == TRUE, ">1.6-Fold","Not deregulated"))) %>%
  #  mutate(color = ifelse(Legend==">1.6-Fold & <0.05 FDR","red",
  #                 ifelse(Legend==">1.6-Fold","blue",
  #                 ifelse(Legend=="Not deregulated","black","gray"
  #                        ))),
  #         order = ifelse(Legend==">1.6-Fold & <0.05 FDR",1,
  #                 ifelse(Legend==">1.6-Fold",2,
  #                 ifelse(Legend=="Not deregulated","black",3
  #                        )))) %>%
  #  arrange(order)
  
  res <- uc.110_miRNAs %>% 
    filter(!is.na(log2FoldChange.y)) %>%
    mutate(color = ifelse(abs(log2FoldChange.x) >= 1 & abs(log2FoldChange.y) >= 1,"#9b00d2",
                   ifelse(abs(log2FoldChange.x) >= 1,"pink",
                   ifelse(abs(log2FoldChange.y) >= 1,"#b9d4ed","lightgray"
                          ))),
           order = ifelse(abs(log2FoldChange.x) >= 1 & abs(log2FoldChange.y) >= 1,1,
                   ifelse(abs(log2FoldChange.x) >= 1,2,
                   ifelse(abs(log2FoldChange.y),3,4
                          ))),
           newname = ifelse(`Target gene` == "MFRP","MFRP",""),
           legend = ifelse(abs(log2FoldChange.x) >= 1 & abs(log2FoldChange.y) >= 1,">= 2-FC Both",
                   ifelse(abs(log2FoldChange.x) >= 1,">= 2-FC A172s only",
                   ifelse(abs(log2FoldChange.y) >= 1,">= 2-FC TCGA only","Neither"
                          )))) %>%
    arrange(order)
    
#p <- ggplot(res,aes(x=TUC110_rank, y=GBM_rank,label=label,color=color)) +
p <- ggplot(res,aes(x=log2FoldChange.x, y=log2FoldChange.y)) +
        geom_point(data = res,aes(x=log2FoldChange.x, y=log2FoldChange.y,color=color,size=20)) +
        #geom_hline(yintercept = log10(5),linetype = 2,size=1.5) +
        #geom_vline(xintercept = -0.65,linetype = 2,size=1.5) +
        #geom_vline(xintercept = 0.65,linetype = 2,size=1.5) +
        #scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
        scale_color_identity(guide = "legend", breaks = res$color, labels = res$legend) +
        ggtitle("") +
        guides(colour = guide_legend(override.aes = list(size=2.5))) +
        labs(x = "Fold Change (TCGA GBM tumor v normal brain cortex)",
        #y = "-log10 adjusted p-value",
        y = "Fold Change (A172 si-uc.110 v si-SCR)") +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(2.0), face="bold"),
              axis.text = element_text(size = rel(2.2), face="bold"),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=20)) + 
  geom_label_repel(data = res,aes(x=log2FoldChange.x, y=log2FoldChange.y,label=newname),force=300,stat = "unique",min.segment.length = 0,size=rel(10.0)) 

p

ggsave(output, width = 10, height = 6, dpi = dpi)

  res2 <- res_myron %>% 
    #filter(log2FoldChange >= -5) %>%
    mutate(color = ifelse(abs(log2FoldChange) >= 1 & pvalue <= 0.05,"#9b00d2",
                   ifelse(abs(log2FoldChange) >= 1,"pink",
                   ifelse(pvalue <= 0.05,"#b9d4ed","lightgray"
                          ))),
           order = ifelse(abs(log2FoldChange) >= 1 & pvalue <= 0.05,1,
                   ifelse(abs(log2FoldChange) >= 1,2,
                   ifelse(pvalue <= 0.05,3,4
                          ))),
           newname = ifelse(`Target gene` == "MFRP","MFRP",
                            ifelse(`Target gene` == "LINC01038","LINC01038",
                            ifelse(`Target gene` == "LINC01068","LINC01068",
                            ifelse(`Target gene` == "LINC01643","LINC01643",
                            ifelse(`Target gene` == "ST18","ST18",""))))),
           legend = ifelse(abs(log2FoldChange) >= 1 & pvalue <= 0.05,">= 2 FC & 0.05 FDR",
                   ifelse(abs(log2FoldChange) >= 1,">= 2 FC",
                   ifelse(pvalue <= 0.05,"0.05 FDR","Neither"
                          )))) %>%
    filter(!is.na(legend)) %>%
    arrange(order)

p <- ggplot(res2,aes(x=log2FoldChange, y=-log10(pvalue))) +
        geom_point(data = res2,aes(x=log2FoldChange, y=-log10(pvalue),color=color)) +
        scale_x_continuous(breaks=seq(-5,5,1)) +
        scale_y_continuous(breaks=seq(0,15,3)) +
        scale_color_identity(guide = "legend", breaks = res2$color, labels = res2$legend) +
        ggtitle("") +
        guides(colour = guide_legend(override.aes = list(size=2.5))) +
        geom_hline(yintercept = 1.30,linetype = 2) +
        geom_vline(xintercept = -1,linetype = 2) +
        geom_vline(xintercept = 1,linetype = 2) +
        labs(x = "Fold Change (A172 si-uc.110 vs si-SCR)",
        #y = "-log10 adjusted p-value",
        y = "-log10(padj)") +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(2.2), face="bold"),
              axis.text = element_text(size = rel(2.2), face="bold"),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.2))) #+ 
  #geom_label_repel(data = res2,aes(x=log2FoldChange, y=-log10(pvalue),label=res2$newname),force=100,stat = "unique",min.segment.length = 0) 

p

ggsave(output2, width = 12, height = 8, dpi = dpi)
}

volcanoplot_mirna(uc.110_miRNAs)

```


## Write function to plot potential TUC110-miR regulated genes

```{r plot_deseq_miRs_cont}

#uc.110_miRNAs$label[9] <- ""



```

## Check out Wnt Signaling pathway

```{r wnt}

res_wnt <- res_myron %>%
  filter(`Target gene` == "CTNNB1" |`Target gene` == "TCF7"|`Target gene` == "TCF7L2"|`Target gene` == "LEF1"|`Target gene` == "GSK3B"|`Target gene` == "DVL1"|`Target gene` == "GSK3B"|`Target gene` == "DVL2"|`Target gene` == "DVL3"|`Target gene` == "TCF7L1"|`Target gene` == "CCND1"|`Target gene` == "CCND2"|`Target gene` == "CCND3"|`Target gene` == "MMP7") %>%
  dplyr::select(`Target gene`,log2FoldChange,padj) %>%
  write_csv(paste(outputdir,"/miRAnalysis/","wntsignaling.csv",sep=""))

res_smad <- res_myron %>%
  filter(`Target gene` == "SMAD1"|`Target gene` == "SMAD2"|`Target gene` == "SMAD3") %>%
  dplyr::select(`Target gene`,log2FoldChange,padj) %>%
  write_csv(paste(outputdir,"/miRAnalysis/","smadsignaling.csv",sep=""))

res_mapk <- res_myron %>%
  filter(str_detect(`Target gene`,"MAPK")|str_detect(`Target gene`,"MAP2K")|`Target gene` == "HRAS"|`Target gene` == "NRAS"|`Target gene` == "KRAS"|`Target gene` == "BRAF") %>%
  dplyr::select(`Target gene`,log2FoldChange,padj) %>%
  write_csv(paste(outputdir,"/miRAnalysis/","mapksignaling.csv",sep=""))

```

## RNA-Seq and stuff

```{r 20220225}

if(!dir.exists(paste(outputdir,"/20220225/",sep=""))){
  dir.create(paste(outputdir,"/20220225/",sep=""))
}

res_myron <- read_csv(paste(outputdir,"/ExpressionAnalysis/DESeq2Results/",disease,"_Myron_20220225_results_allgenes.csv",sep=""))

cancermine <- read.csv("cancermine_genelist_results.csv",header=TRUE) %>%
  dplyr::select("Target gene"=target,role)

## Positive

uc.110_poscor <- read_csv(paste(outputdir,"/GuiltAnalysis/correlations/positive/uc.110_plus_correlations.csv",sep="")) %>%
  separate(`...1`,c("Target gene","kibble"),sep="___") %>%
  dplyr::select("Target gene","cor")

res_rnaseq_onc <- res_myron %>%
  inner_join(uc.110_poscor,by="Target gene") %>%
  filter(abs(log2FoldChange) >= log2(1.6) & !is.na(kibble)) %>%
  dplyr::select(-padj)

res_cancermine_onc <- res_rnaseq_onc %>%
  inner_join(cancermine,by="Target gene") %>%
  filter(role == "ONC" & log2FoldChange < 0)

## Negative

uc.110_negcor <- read_csv(paste(outputdir,"/GuiltAnalysis/correlations/negative/uc.110_minus_correlations.csv",sep="")) %>%
  separate(`...1`,c("Target gene","kibble"),sep="___") %>%
  dplyr::select("Target gene","cor")

res_rnaseq_tsg <- res_myron %>%
  inner_join(uc.110_negcor,by="Target gene") %>%
  filter(abs(log2FoldChange) >= log2(1.6) & !is.na(kibble)) %>%
  dplyr::select(-padj)

res_cancermine_tsg <- res_rnaseq_tsg %>%
  inner_join(cancermine,by="Target gene") %>%
  filter(role == "TSG" & log2FoldChange > 0)

## Join

res_cancermine_all <- rbind(res_cancermine_onc,res_cancermine_tsg) %>%
  write_csv(paste(outputdir,"/20220225/",disease,"_Myron_20220225_cancermine_allgenes.csv",sep=""))

```

## Create Directory for Bench Experiments

```{r benchexperiments}

if(!dir.exists(paste(outputdir,"/BenchExperiments/",sep=""))){
  dir.create(paste(outputdir,"/BenchExperiments/",sep=""))
}

```

## Cell Fractionation Data

```{r cellfrac}

data <- read_csv("BenchExperiments/cellfractionation.csv")

p <- ggplot(data,aes(x=reorder(Sample,Order), y=Value,fill=Fraction)) +
        geom_bar(stat="identity"
                 #,color="black"
                 ) +
        geom_errorbar(aes(ymax=Ymax, ymin=Ymin, width=.2,vjust=0.5,hjust=1)) +
        geom_text(aes(y = 1.02, label=pvalue),color = "black",size=10) + 
        #geom_hline(yintercept = log10(5),linetype = 2,size=1.5) +
        #geom_vline(xintercept = -0.65,linetype = 2,size=1.5) +
        #geom_vline(xintercept = 0.65,linetype = 2,size=1.5) +
        #scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
        scale_fill_manual(values = c(paper_red2,paper_turq)) +
        #guides(colour = guide_legend(override.aes = list(size=10))) +
        labs(y = "fraction of total RNA expression",
        x = "Sample") +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(2.0), face="bold"),
              axis.text.y = element_text(size = rel(2.0), face="bold"),
              axis.text.x = element_text(size = rel(2.0), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=20),
strip.text.x = element_text(size = rel(1.6)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~Gene, ncol=5)

p

ggsave(file=paste(outputdir,"/BenchExperiments/cellfrac.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

## uc.110 expression in GBM Cell Lines

```{r uc.110_cellLines}

data <- read_csv("BenchExperiments/uc110_cellLines.csv") 

p <- ggplot(data,aes(x=reorder(Sample,Order), y=as.numeric(FoldChange),fill=Sample)) +
        geom_bar(stat="identity"
                 #,color="black"
                   ) +
        geom_errorbar(aes(ymax=FoldChange+stderr, ymin=FoldChange-stderr, width=.2)) +
        geom_text(aes(y = FoldChange, label=pvalue,vjust=ifelse(FoldChange>0,0,1.75),hjust=0.5),color = "#000000",size=10) + 
        scale_y_continuous(limits = c(-5,10),breaks= scales::pretty_breaks(n=15)) +
        #geom_hline(yintercept = log10(5),linetype = 2,size=1.5) +
        #geom_vline(xintercept = -0.65,linetype = 2,size=1.5) +
        #geom_vline(xintercept = 0.65,linetype = 2,size=1.5) +
        #scale_color_identity(guide = "legend", labels = cellfracdata$Fraction, breaks = cellfracdata$Fraction) +
        labs(y = "log2(uc.110 FoldChange)",
        x = "GBM Cell Line") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.0), face="bold"),
              axis.text.x = element_text(size = rel(2.0), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_blank()) + 
  coord_cartesian(clip = "off")

p

ggsave(file=paste(outputdir,"/BenchExperiments/uc110_cellLines.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

## uc.110 expression in GBM Tumors (summarized)

```{r uc.110_cellLines2}

data <- read_csv("BenchExperiments/uc110_cellLines3.csv") 

p <- ggplot(data,aes(x=dex, y=FC,fill=Fill)) +
  geom_boxplot(outlier.color="white") +
  #geom_bar(colour="black",stat="identity") +
  scale_fill_identity() +
  #scale_color_manual(values = c("black"="black","red"="red","green"="green")) +
  geom_jitter(data = data, aes(x=dex, y=FC),binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.8), face="bold"),
        axis.text.y = element_text(size = rel(2.5), face="bold"),
        axis.text.x = element_text(size = rel(2.5), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
  labs(y="log2FoldChange", x = "Tissue Type") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)

p

ggsave(file=paste(outputdir,"/BenchExperiments/uc110_cellLines3.png",sep=""),
       plot = print(p),
       height = 7,
       width = 4,
       dpi = 300)

data <- read_csv("BenchExperiments/uc110_cellLines4.csv") 

p <- ggplot(data,aes(x=dex, y=FC,fill=Fill)) +
  geom_boxplot(outlier.color="white") +
  #geom_bar(colour="black",stat="identity") +
  scale_fill_identity() +
  #scale_color_manual(values = c("black"="black","red"="red","green"="green")) +
  geom_jitter(data = data, aes(x=dex, y=FC),binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.8), face="bold"),
        axis.text.y = element_text(size = rel(2.5), face="bold"),
        axis.text.x = element_text(size = rel(2.5), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
  labs(y="log2FoldChange", x = "Tissue Type") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)

p

ggsave(file=paste(outputdir,"/BenchExperiments/uc110_cellLines4.png",sep=""),
       plot = print(p),
       height = 7,
       width = 4,
       dpi = 300)

```

## uc.110 expression in GBM Tumors

```{r uc.110_gbmtumors}

data <- read_csv("BenchExperiments/uc110_gbmtumors.csv") 

p <- ggplot(data,aes(x=reorder(Sample,Order), y=as.numeric(FoldChange),fill=Sample)) +
        geom_bar(stat="identity"
                 #,color="black"
                   ) +
        geom_errorbar(aes(ymax=FoldChange+stderr, ymin=FoldChange-stderr, width=.2)) +
        geom_text(aes(y = FoldChange, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10) + 
        scale_y_continuous(limits = c(-0.25,7),breaks= scales::pretty_breaks(n=9)) +
        #geom_hline(yintercept = log10(5),linetype = 2,size=1.5) +
        #geom_vline(xintercept = -0.65,linetype = 2,size=1.5) +
        #geom_vline(xintercept = 0.65,linetype = 2,size=1.5) +
        #scale_color_identity(guide = "legend", labels = cellfracdata$Fraction, breaks = cellfracdata$Fraction) +
        labs(y = "log2(uc.110 FoldChange)",
        x = "GT = GBM Tumor, NBC = Normal Brain Cortex") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_blank()) + 
  coord_cartesian(clip = "off")

p

ggsave(file=paste(outputdir,"/BenchExperiments/uc110_gbmtumors.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

## uc.110 expression in GBM Tumors (summarized)

```{r uc.110_gbmtumors}

data <- read_csv("BenchExperiments/uc110_gbmtumors2.csv") 

p <- ggplot(data,aes(x=dex, y=FC,fill=Fill)) +
  geom_boxplot(outlier.color="white") +
  #geom_bar(colour="black",stat="identity") +
  scale_fill_identity() +
  #scale_color_manual(values = c("black"="black","red"="red","green"="green")) +
  geom_jitter(data = data, aes(x=dex, y=FC),binaxis='y', stackdir='center', stackratio=0.90, dotsize=0.30,fill="gray",width=0.2) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.8), face="bold"),
        axis.text.y = element_text(size = rel(2.5), face="bold"),
        axis.text.x = element_text(size = rel(2.5), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="none",
        legend.title=element_blank(),
        legend.text=element_blank()) +
  labs(y="log2FoldChange", x = "Tissue Type") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color=paper_blue, fill=paper_blue)

p

ggsave(file=paste(outputdir,"/BenchExperiments/uc110_gbmtumors2.png",sep=""),
       plot = print(p),
       height = 7,
       width = 5,
       dpi = 300)

```

```{r uc.110_proliferation_WT}

data <- read_csv("BenchExperiments/proliferation_WT.csv") %>%
  group_by(Day,siRNA,Sample,Color) %>%
  dplyr::summarise(mean = mean(Count,na.rm=TRUE),n=n(),stddev= sd(Count,na.rm=TRUE),stderr=stddev/n) %>%
  mutate(pvalue = ifelse(Day == 7 & siRNA != "si-SCR" & Sample == "A172","*",
                  ifelse(Day == 5 & siRNA != "si-SCR" & Sample == "U251","*","")))

p <- ggplot(data,aes(x=Day,y=mean,color=siRNA)) +
  geom_line(size=1.2) +
  geom_point(size=3) +
  geom_text(aes(x=Day,y=mean, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10) +
  geom_errorbar(aes(ymax=mean+stderr, ymin=mean-stderr, width=.2)) +
  scale_color_manual(values = c(paper_red,paper_green,paper_blue)) +
  labs(y = "Number of Cells",
        x = "Days post transfection") +
  theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.2)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~Sample) 

p

ggsave(file=paste(outputdir,"/BenchExperiments/proliferation_WT.png",sep=""),
       plot = print(p),
       height = 5,
       width = 10,
       dpi = 300)

```

```{r uc.110_qpcr_rescue}

data <- read_csv("BenchExperiments/qpcr_rescue.csv") %>% 
  mutate(fillcolor = paste(Gene,Sample,sep=" "))

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_gold,paper_turq,paper_purple)) +
        labs(y = "Relative uc.110 expression",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2),face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.2)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank(),) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/qpcr_rescue.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_accum_rescue}

data <- read_csv("BenchExperiments/accum_rescue.csv") %>% 
  mutate(fillcolor = paste(Gene,Sample,sep=" "))

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_gold,paper_turq,paper_purple)) +
        labs(y = "Relative accumulated cells",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/accum_rescue.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_AB_rescue}

data <- read_csv("BenchExperiments/AB_rescue.csv") %>% 
  mutate(fillcolor = paste(Gene,Sample,sep=" "))

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_gold,paper_turq,paper_purple)) +
        labs(y = "Relative AlamarBlue Signal",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.2)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/AB_rescue.png",sep=""),
       plot = print(p),
       height = 6,
       width = 7,
       dpi = 300)

```

```{r uc.110_AB_stemcells}

data <- read_csv("BenchExperiments/AB_stemcells.csv") %>% 
  mutate(fillcolor = paste(Gene,Sample,sep=" "))

p <- ggplot(data,aes(x=reorder(Sample,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_gold,paper_turq,paper_purple)) +
        labs(y = "Relative AlamarBlue Signal",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/AB_stemcells.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_invasion}

data <- read_csv("BenchExperiments/invasion.csv") 

p <- ggplot(data,aes(x=reorder(Sample,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_gold,paper_turq,paper_purple)) +
        labs(y = "Relative invading cells",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/invasion.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_invasion_rescue}

data <- read_csv("BenchExperiments/invasion_rescue.csv") %>% 
  mutate(fillcolor = paste(Gene,Sample,sep=" "))

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-0.25,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_green,paper_blue,paper_red,paper_green,paper_blue)) +
        labs(y = "Relative invading cells",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/invasion_rescue.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_qpcr_ovrexp}

data <- read_csv("BenchExperiments/Ovrexp_qPCR.csv")

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=Gene)) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-3.0,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_gold,paper_purple)) +
        labs(y = "Relative uc.110 expression",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank(),) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/Ovrexp_qPCR.png",sep=""),
       plot = print(p),
       height = 8,
       width = 4,
       dpi = 300)

```

```{r uc.110_accum_ovrexp}

data <- read_csv("BenchExperiments/Ovrexp_accum.csv")

p <- ggplot(data,aes(x=reorder(Gene,order), y=FC,fill=Gene)) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_gold,paper_purple)) +
        labs(y = "Relative accumulated cells",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank(),) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/Ovrexp_accum.png",sep=""),
       plot = print(p),
       height = 8,
       width = 4,
       dpi = 300)

```

```{r uc.110_accum_miRNA}

data <- read_csv("BenchExperiments/accum_miRNA2.csv")

p <- ggplot(data,aes(x=reorder(Sample,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC, label=pvalue,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        #scale_fill_manual(values = c("#F8766D","#0CB702","#619CFF","#D39200","#00C19F","#DB72FB")) +
        scale_fill_manual(values = c(paper_red,paper_yellow)) +
        labs(y = "Relative accumulated cells",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

ggsave(file=paste(outputdir,"/BenchExperiments/accum_miRNA.png",sep=""),
       plot = print(p),
       height = 6,
       width = 6,
       dpi = 300)

```

```{r uc.110_qPCR_miRNA,fig.width=15,fig.height=10}

data <- read_csv("BenchExperiments/qPCR_miRNA3.csv")

p <- ggplot(data,aes(x=reorder(Sample,order), y=FC,fill=reorder(Sample,order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=FC+stderr, ymin=FC-stderr, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = FC+stderr+0.01, label=pvalue,vjust=-1,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_blue,paper_yellow)) +
        labs(y = "Relative gene expression",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(2), face="bold"),
              axis.text.y = element_text(size = rel(2.2)),
              axis.text.x = element_text(size = rel(2.2),angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine+Gene,ncol=4)


p

ggsave(file=paste(outputdir,"/BenchExperiments/qPCR_miRNA.png",sep=""),
       plot = print(p),
       height = 6,
       width = 9,
       dpi = 300)

```

```{r CAGE_full_transcripts}

data <- read_delim("CAGE_transcripts.bed",delim="\t",col_names=F) %>%
  dplyr::group_by(X4,X5) %>%
  dplyr::mutate(n = n(),start = min(X2,na.rm=TRUE),end = max(X3,na.rm=TRUE),name=X4) %>%
  dplyr::ungroup() %>%
  dplyr::select("chr"=X1,start,end,"gene"=X4,"strand"=X5,name) %>%
  distinct() %>%
  separate(name,into=c("alias","gene"),sep="_") 

annot <- read_delim("hg38.ultraconserved.bed",delim="\t",col_names=T) %>%
  dplyr::select(alias,annot)

data <- data %>%
  left_join(annot,by="alias") %>%
  mutate(name = paste(alias,gene,sep="_")) %>%
  dplyr::select(chr,start,end,name,strand,annot) %>%
  write_delim("CAGE_alltranscripts.bed",delim="\t")

```

```{r CAGE_full_loader}

data <- read_delim("CAGE_loader.bed",delim="\t",col_names=F) %>%
  dplyr::group_by(X4,X5) %>%
  dplyr::mutate(start = sum(min(X2,na.rm=TRUE),X6,na.rm=TRUE),end = max(X3,na.rm=TRUE),name=X4) %>%
  dplyr::ungroup() %>%
  dplyr::select("chr"=X1,start,end,"gene"=X4,"strand"=X5,name) %>%
  distinct() %>%
  separate(name,into=c("alias","gene"),sep="_") 

annot <- read_delim("hg38.ultraconserved.bed",delim="\t",col_names=T) %>%
  dplyr::select(alias,annot)

data <- data %>%
  left_join(annot,by="alias") %>%
  mutate(name = paste(alias,gene,sep="_")) %>%
  dplyr::select(chr,start,end,name,strand,annot) %>%
  mutate(prom_start = ifelse(strand== "+",start-3000,end),prom_end = ifelse(strand== "+",start,end+3000)) %>%
  write_delim("CAGE_results_3000.bed",delim="\t")

data2 <- data %>%
  dplyr::select(chr,prom_start,prom_end,name,strand) %>%
  write_delim("CAGE_promoters.bed",delim="\t")

```

### Writing a script to generate a volcano plot

```{r Section2_volcanoplot, eval = FALSE}

res_YG <- read.csv("./Outputs_Myron_20220801/ExpressionAnalysis/DESeq2Results/GBM_results_allgenes.csv",header=TRUE) %>%
  dplyr::select(Target.gene,log2FoldChange,"padj"=pvalue)

load("uc110_coreg.RData")

coreg_genes <- geneTraitSignificance %>%
  mutate(partner = row.names(geneTraitSignificance))

colnames(coreg_genes) <- c("cor","partner")

coreg_genes <- coreg_genes %>%
  separate(partner,c("Target.gene","Kibble"),"___") %>%
  dplyr::select(Target.gene,cor) %>%
  left_join(res_YG,by="Target.gene")
  
  

#coreg_genes_plus <- read.csv("./Outputs_GBM_cortex_20220810/GuiltAnalysis/correlations/positive/uc.110_plus_correlations.csv",header=TRUE)

#coreg_genes_minus <- read.csv("./Outputs_GBM_cortex_20220810/GuiltAnalysis/correlations/negative/uc.110_minus_correlations.csv",header=TRUE)

#coreg_genes <- rbind(coreg_genes_plus,coreg_genes_minus) %>%
#  separate(partner,c("Target.gene","Kibble"),"___") %>%
#  dplyr::select(Target.gene,cor) %>%
#+  left_join(res_YG,by="Target.gene")

coreg_genes <- coreg_genes[complete.cases(coreg_genes),]

### Volcano plot

volcanoplot <- function (res,
                         genes = "all",
                         title = paste("Deregulated mut-p53-associated lncRNAs in TCGA (",disease,")",sep=""), 
                         output = paste(outputdir,"/",p53status_var,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot.png",sep=""),
                         height = 7, 
                         width = 15, 
                         dpi = 300){
  #res <- hypoxia_results
  #genes <- "all"
  #genes = c("uc.110")
  #title = "Deregulated Genes"
  #res <- res %>% 
  #  mutate(filter1 = abs(log2FoldChange)>=0.65,filter2 = pvalue <=0.05) %>%
  #  mutate(Legend = ifelse(filter1 == TRUE & filter2 == TRUE, ">1.6-Fold & <0.05 FDR",
  #                  ifelse(filter1 == TRUE, ">1.6-Fold","Not deregulated"))) %>%
  #  mutate(color = ifelse(Legend==">1.6-Fold & <0.05 FDR","red",
  #                 ifelse(Legend==">1.6-Fold","blue",
  #                 ifelse(Legend=="Not deregulated","black","gray"
  #                        ))),
  #         order = ifelse(Legend==">1.6-Fold & <0.05 FDR",1,
  #                 ifelse(Legend==">1.6-Fold",2,
  #                 ifelse(Legend=="Not deregulated","black",3
  #                        )))) %>%
  #  arrange(order)
  
  res <- coreg_genes
  
  res <- res %>% 
    filter(log2FoldChange > -5) %>%
    mutate(filter1 = abs(log2FoldChange)>=1,filter2 = padj <= 0.05,filter3 = log2FoldChange <0) %>%
    mutate(Legend = ifelse(filter1 == TRUE & filter2 == TRUE, ">= 2-FC & 0.05 FDR",
                    ifelse(filter1 == TRUE, ">= 2-FC",
                    ifelse(filter2 == TRUE, "0.05 FDR","Not Significant")))) %>%
    mutate(color = ifelse(Legend==">= 2-FC & 0.05 FDR","#9b00d2",
                   ifelse(Legend==">= 2-FC","pink",
                   ifelse(Legend=="0.05 FDR","#b9d4ed",
                   ifelse(Legend=="Not Significant","lightgray","black"
                          )))),
           order = ifelse(Legend==">= 2-FC & 0.05 FDR",1,
                   ifelse(Legend==">= 2-FC",2,
                   ifelse(Legend=="0.05 FDR",3,
                   ifelse(Legend=="Not Significant",4,5
                          ))))) %>%
    arrange(order) %>%
    filter(Target.gene != "CHESS1725")
  
  res_rematcher <- res %>%
    filter(Target.gene == "MFRP")
  
  ## plot
p <- ggplot(res,aes(x=log2FoldChange, y=-log10(padj),label=Target.gene)) +
        #geom_text_repel() +
        #geom_point(aes(x=log2FoldChange, y=-log10(pvalue),col=color)) +
        #geom_hline(yintercept = 1.30,linetype = 2) +
        geom_point(aes(x=log2FoldChange, y=-log10(padj),col=color),size=1.15) +
        geom_hline(yintercept = -log10(0.05),linetype = 2) +
        geom_vline(xintercept = -1,linetype = 2) +
        geom_vline(xintercept = 1,linetype = 2) +
        scale_color_identity(guide = "legend", labels = res$Legend, breaks = res$color) +
        ggtitle(title) +
        guides(colour = guide_legend(override.aes = list(size=6))) +
        labs(x = "log2 fold change of gene in A172 Cells",
        y = "-log10 adjusted p-value",
        color = "Legend") +
        geom_label_repel(data = res_rematcher,aes(x=log2FoldChange, y=-log10(padj),label=Target.gene),force=500,stat = "unique",min.segment.length = 0,size=rel(10.0)) +
        theme(plot.title = element_blank(),
              axis.title = element_text(size = rel(2.2), face="bold"),
              axis.text = element_text(size = rel(2.2), face="bold"),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=rel(2.2))) +
  coord_cartesian(clip = "off")

p

ggsave(output, width = width, height = height, dpi = dpi)
#ggsave(p,output = paste(outputdir,"/A172_volcano_allgenes.png",sep=""),
#                         height = 6, 
#                         width = 12, 
#                         dpi = 300)
}

volcanoplot(coreg_genes,
                         title = paste("Deregulated uc.110-coregulated genes in A172 cells",sep=""), 
                         output = paste(outputdir,"/A172_volcano_allgenes.png",sep=""),
                         height = 6, 
                         width = 12, 
                         dpi = 300)

```

```{r tcfluc_results}

data <- read_csv("BenchExperiments/TCFLUC_assayresults.csv") %>%
  dplyr::select(CellLine,Sample,MEAN,SE,SIG,Order)

p <- ggplot(data,aes(x=reorder(Sample,Order), y=MEAN,fill=reorder(Sample,Order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=MEAN+SE, ymin=MEAN-SE, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = MEAN, label= SIG,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_blue,paper_yellow,paper_red,paper_blue,paper_yellow)) +
        labs(y = "Relative TCF/LUC reporter expression",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine)


p

dir.create(paste(outputdir,"/BenchExperiments/",sep=""))

ggsave(file=paste(outputdir,"/BenchExperiments/tcfluc.png",sep=""),
       plot=print(p),
       height = 7,
       width = 9,
       dpi = 300)

```

```{r tcfluc_results}

data <- read_csv("BenchExperiments/LUC-uc110-results.csv") 

data$CellLine <- factor(data$CellLine, levels = c("A172 WT","A172 MUT","U251 WT","U251 MUT"))

p <- ggplot(data,aes(x=reorder(Sample,Order),y=MEAN,fill=reorder(Sample,Order))) +
        geom_bar(stat="identity",position = "dodge") +
        geom_errorbar(aes(ymax=MEAN+SE, ymin=MEAN-SE, width=.2),position = position_dodge(0.9)) +
        geom_text(aes(y = MEAN, label= SIG,vjust=-1.5,hjust=0.5),color = "#000000",size=10,position = position_dodge(0.9)) + 
        scale_fill_manual(values = c(paper_red,paper_blue,paper_red2,paper_yellow)) +
        labs(y = "Relative uc.110/LUC reporter expression",
        x = "") +
        #ylim(-5, 10) +
        theme(plot.title = element_text(size = rel(2.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              axis.title = element_text(size = rel(1.6), face="bold"),
              axis.text.y = element_text(size = rel(2.2), face="bold"),
              axis.text.x = element_text(size = rel(2.2), face="bold",angle=90,vjust = 0.5, hjust=1),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_text(size=rel(2.0)),
strip.text.x = element_text(size = rel(2.2)),
strip.background = element_blank()) + 
  coord_cartesian(clip = "off") +
  facet_wrap(~CellLine,ncol=4)


p

dir.create(paste(outputdir,"/BenchExperiments/",sep=""))

ggsave(file=paste(outputdir,"/BenchExperiments/uc110-luc.png",sep=""),
       plot=print(p),
       height = 6,
       width = 8,
       dpi = 300)

```

```{r annotation sizes}

library(tidyverse)

detach(package:plyr)

data <- read_delim("allgenes.bed",delim="\t",col_names = FALSE) %>%
  mutate(length = X3-X2) %>%
  dplyr::group_by(X8) %>%
  summarize(bases = sum(length,na.rm=TRUE)) 

data2 <- read_delim("allgenes.bed",delim="\t",col_names = FALSE) %>%
  filter(X8 != "random") %>%
  mutate(length = X3-X2) %>%
  dplyr::group_by(X7) %>%
  summarize(bases = sum(length,na.rm=TRUE)) 

```

```{r }

#Prepare data for visualization
plot_annotation <- tucr_annot %>% 
  group_by(annot) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent = count/sum(count)) %>%
  arrange(desc(count)) %>%
#Determine label positions
  mutate(lab.ypos = cumsum(count) - 0.5*count)

#Set factor levels
names(plot_annotation)[names(plot_annotation) == 'annot'] <- 
  'Annotation'

#Create Chart
figure1e <- ggplot(plot_annotation, aes(x=2,y=count,fill=Annotation))          + 
  geom_bar(
    stat="identity",#colour="black", 
    width = 1)                                                          +
  geom_text(
    aes(y = lab.ypos, label = count), 
    color = "black",size=5)                                                    + 
  coord_polar("y", start=0)                                             + 
  scale_fill_manual(values=c(paper_red,paper_purple,paper_green,paper_blue))  + 
  ggtitle(paste("TUCR Genomic Location"))                               + 
  guides(colour = guide_legend(override.aes = list(size=10))) +
        theme(plot.title = element_blank(),
              axis.title = element_blank(),
              axis.text.y = element_blank(),
              axis.text.x = element_blank(),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_blank(),legend.position="top",legend.title=element_blank(),
legend.text=element_text(size=10),
axis.ticks = element_blank(), 
      legend.box.spacing = unit(0, "pt"),
legend.margin=margin(0,0,0,0)) +
  xlim(0.5, 2.5)
  
figure1e

#figure1 <- ggarrange(figure1a_d,figure1e,
#                    labels = c("", "E"),
#                    ncol = 1, nrow = 2)

#Save Chart to output directory
ggsave(file=paste(outputdir,"/",disease,"_tucr_annotation.png",sep=""),
       plot = print(figure1e), 
       dpi = 300,
       height = 4.75,
       width = 4.75)

```

```{r}

res_TUCR_LGG <- read_csv(paste("Outputs_LGG_cortex_20230809/ExpressionAnalysis/DESeq2Results/LGG_results_",filterannot,".csv",sep=""),col_names = TRUE)

res_TUCR_GBM <- read_csv(paste("Outputs_GBM_cortex_20230809/ExpressionAnalysis/DESeq2Results/GBM_results_",filterannot,".csv",sep=""),col_names = TRUE)

tucr_annot <- read_delim("hg38.ultraconserved.bed",col_names = TRUE,delim="\t") 

res_TUCR_LGG_2 <- res_TUCR_LGG %>%
  separate(row,into=c("alias","kibble"),sep="___") %>%
  dplyr::select(-kibble) %>% 
  left_join(tucr_annot,by="alias") %>%
  filter(!is.na(chrom)) %>%
  dplyr::select(alias,log2FoldChange,padj) %>%
  mutate(disease = "LGG")

res_TUCR_GBM_2 <- res_TUCR_GBM %>%
  separate(row,into=c("alias","kibble"),sep="___") %>%
  dplyr::select(-kibble) %>% 
  left_join(tucr_annot,by="alias") %>%
  filter(!is.na(chrom)) %>%
  dplyr::select(alias,log2FoldChange,padj) %>%
  mutate(disease = "GBM")

res_TUCR <- rbind(res_TUCR_GBM_2,res_TUCR_LGG_2)

res_summary <- res_TUCR %>%
  mutate(dereg = ifelse(log2FoldChange >=1  & padj <= 0.05, "upregulated",
                    ifelse(log2FoldChange <=-1  & padj <= 0.05,"downregulated","unchanged")),
         deregcount = ifelse(log2FoldChange >=1  & padj <= 0.05, 1,
                    ifelse(log2FoldChange <=-1  & padj <= 0.05,-1,0))) %>%
  dplyr::group_by(alias) %>%
  dplyr::mutate(sum = sum(deregcount,na.rm=TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(deregcategory = ifelse(sum == 2, "Up-Both",
                                ifelse(sum == -2, "Down-Both",
                                ifelse(sum == 1 & dereg == "upregulated" & disease == "GBM","Up-GBM",
                                ifelse(sum == 1  & dereg == "upregulated" &  disease == "LGG", "Up-LGG",
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "LGG", "Down-LGG",
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "GBM", "Down-GBM","not deregulated"))))))) %>%
  filter(deregcategory != "not deregulated" & padj != 0) %>%
  dplyr::select(alias,deregcategory) %>%
  distinct() %>%
  group_by(deregcategory) %>%
  dplyr::summarize(n = n()) %>%
  mutate(dereg = ifelse(str_detect(deregcategory,"Up"),"Upregulated","Downregulated")) %>%
  group_by(dereg) %>%
  dplyr::mutate(deregcounts = sum(n),circlecounts=(n/deregcounts)*360,min = cumsum(circlecounts) - circlecounts,lab.ypos = 360-(cumsum(circlecounts) - 0.5*circlecounts)) %>%
  ungroup() %>%
  mutate(allsum = sum(n))
  #dplyr::mutate(deregcounts = n(),lab.ypos = (cumsum(n)-deregcounts) - 0.5*n)

p <- ggplot(res_summary, aes(x=2,y=circlecounts,fill=deregcategory))          + 
  geom_bar(
    stat="identity",#colour="black", 
    width = 1)                                                          +
  geom_text(
    aes(y = lab.ypos, label = n), 
    color = "black",size=5)                                                    + 
  coord_polar("y", start=0)                                             + 
  scale_fill_manual(values=c(paper_lightblue,paper_blue,paper_skyblue,paper_darkpink,paper_red,paper_pink))  + 
  ggtitle(paste("TUCR Genomic Location"))                               + 
  guides(colour = guide_legend(override.aes = list(size=8))) +
        theme(plot.title = element_blank(),
              axis.title = element_blank(),
              axis.text.y = element_blank(),
              axis.text.x = element_blank(),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_blank(),legend.position="none",legend.title=element_blank(),
legend.text = element_text(size = 12.5),
axis.ticks = element_blank(), 
      legend.box.spacing = unit(0, "pt"),
legend.margin=margin(0,0,0,0),
strip.background = element_rect(fill="white"),
strip.text = element_blank(),
panel.spacing = unit(-2, "lines")) +
  xlim(0.5, 2.5) +
  facet_wrap(~dereg)

p

ggsave(file=paste(outputdir,"/ExpressionAnalysis/deregGraph_",filterannot,".png",sep=""),
       plot = print(p),
       width = 6, 
       height = 4, 
       dpi = 300)

```

```{r}

### Volcano plot

volcanoplot_all <- function (res,
                         genes = "all",
                         title = paste("Deregulated TUCRs in TCGA (",disease,")",sep=""), 
                         output = paste(outputdir,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot_both.png",sep=""),
                         height = 7, 
                         width = 10, 
                         dpi = 300,
                         usefacets = TRUE,
                         intergeniconly=FALSE){
  #res <- res_TUCR
  #genes <- "all"
  #genes = c("uc.110")
  #title = "Deregulated Genes"
  
  res <- res_TUCR %>%
  mutate(dereg = ifelse(log2FoldChange >=1, "upregulated",
                    ifelse(log2FoldChange <=-1,"downregulated","unchanged")),
         deregcount = ifelse(log2FoldChange >=1 & padj <= 0.05, 1,
                    ifelse(log2FoldChange <=-1 & padj <= 0.05,-1,0))) %>%
  dplyr::filter(padj != 0 | alias == "uc.61"| alias == "uc.110"| alias == "uc.403") %>%
  dplyr::group_by(alias) %>%
  dplyr::mutate(sum = sum(deregcount,na.rm=TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(deregcategory = ifelse(sum == 2, "Up-Both",
                                ifelse(sum == -2, "Down-Both",
                                ifelse(sum == 1 & dereg == "upregulated" & disease == "GBM","Up-GBM",
                                ifelse(sum == 1  & dereg == "upregulated" &  disease == "LGG", "Up-LGG",
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "LGG", "Down-LGG",
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "GBM", "Down-GBM","not deregulated")))))),
                color = ifelse(sum == 2, paper_darkpink,
                                ifelse(sum == -2, paper_lightblue,
                                ifelse(sum == 1 & dereg == "upregulated" & disease == "GBM",paper_red,
                                ifelse(sum == 1  & dereg == "upregulated" &  disease == "LGG", paper_pink,
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "LGG", paper_skyblue,
                                ifelse(sum == -1  & dereg == "downregulated" &  disease == "GBM", paper_blue,
                                ifelse(disease == "GBM",paper_black,paper_gray))))))))
  
  res_summary <- res %>%
    group_by(color) %>%
    dplyr::summarize(n = n())


  ## plot
if(intergeniconly == TRUE){res <- res %>%
  filter(annot == "intergenic")}
  
if(usefacets == TRUE){
  
res_110_up <- res %>%
   filter(color != paper_gray & color != paper_black & log2FoldChange > 0  | alias == "uc.110"| alias == "uc.403") %>%
   dplyr::arrange(desc(log2FoldChange)) %>%
   dplyr::group_by(annot,disease) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 3 | alias == "uc.61" | alias == "uc.110"| alias == "uc.403")

res_110_down <- res %>%
   filter(color != paper_gray & color != paper_black  & log2FoldChange < 0 | alias == "uc.61") %>%
   dplyr::arrange(log2FoldChange) %>%
   dplyr::group_by(annot,disease) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 3 | alias == "uc.61" | alias == "uc.110"| alias == "uc.403")
  
p <- ggplot(res) +
        #geom_point(aes(x=log2FoldChange, y=-log10(pvalue),col=color)) +
        #geom_hline(yintercept = 1.30,linetype = 2) +
        geom_point(aes(x=log2FoldChange,y=-log10(padj),col=color)) +
        geom_hline(yintercept = -log10(0.05),linetype = 2,size=0.5) +
        geom_vline(xintercept = -1,linetype = 2,size=0.5) +
        geom_vline(xintercept = 1,linetype = 2,size=0.5) +
        scale_color_identity(guide = "deregcategory", labels = res$deregcategory, breaks = res$color) +
        #ggtitle(title) +
        guides(color = guide_legend(override.aes = list(size=5))) +
        geom_text_repel(data= res_110_up,aes(x=log2FoldChange,y=-log10(padj),color=paper_black, label = res_110_up$alias, force=50,vjust=1.5,hjust=1.5)) +
        geom_text_repel(data= res_110_down,aes(x=log2FoldChange,y=-log10(padj),color=paper_black, label = res_110_down$alias, force=50,vjust=1.5,hjust=1.5)) +
        labs(x = "log2 fold change of TUCR in tumors",
        #y = "-log10 adjusted p-value",
        y = "-log10 of adjusted p-value",
        color = "Legend") +
        theme(plot.title = element_text(size = rel(2.0), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              strip.background = element_rect(fill="white"),
              axis.title = element_text(size = rel(1.4), face="bold"),
              strip.text = element_text(size = rel(1.4), face="bold"),
              axis.text = element_text(size = rel(1.0)),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_text(size=10)) +
  coord_cartesian(clip = "off") + 
  facet_wrap(~disease+annot,scales="free",ncol=length(unique(res$annot)))

ggsave(plot = print(p),output, width = width, height = height, dpi = dpi)

}else{

res_110_up <- res %>%
   filter(color != paper_gray & color != paper_black & log2FoldChange > 0 | alias == "uc.110"| alias == "uc.403") %>%
   dplyr::arrange(desc(log2FoldChange)) %>%
   dplyr::group_by(disease) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 3 | alias == "uc.61" | alias == "uc.110"| alias == "uc.403")

res_110_down <- res %>%
   filter(color != paper_gray & color != paper_black  & log2FoldChange < 0 | alias == "uc.61") %>%
   dplyr::arrange(log2FoldChange) %>%
   dplyr::group_by(disease) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 3 | alias == "uc.61" | alias == "uc.110"| alias == "uc.403")
  
p <- ggplot(res) +
        #geom_point(aes(x=log2FoldChange, y=-log10(pvalue),col=color)) +
        #geom_hline(yintercept = 1.30,linetype = 2) +
        geom_point(aes(x=log2FoldChange,y=-log10(padj),col=color)) +
        geom_hline(yintercept = -log10(0.05),linetype = 2,size=0.5) +
        geom_vline(xintercept = -1,linetype = 2,size=0.5) +
        geom_vline(xintercept = 1,linetype = 2,size=0.5) +
        scale_color_identity(guide = "deregcategory", labels = res$deregcategory, breaks = res$color) +
        #ggtitle(title) +
        guides(color = guide_legend(override.aes = list(size=5))) +
        geom_text_repel(data= res_110_up,aes(x=log2FoldChange,y=-log10(padj),color=paper_black, label = res_110_up$alias, force=50,vjust=1.5,hjust=1.5)) +
        geom_text_repel(data= res_110_down,aes(x=log2FoldChange,y=-log10(padj),color=paper_black, label = res_110_down$alias, force=50,vjust=1.5,hjust=1.5)) +
        labs(x = "log2 fold change of TUCR in tumors",
        #y = "-log10 adjusted p-value",
        y = "-log10 of adjusted p-value",
        color = "Legend") +
        theme(plot.title = element_text(size = rel(2.0), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              strip.background = element_rect(fill="white"),
              axis.title = element_text(size = rel(1.4), face="bold"),
              strip.text = element_text(size = rel(1.4), face="bold"),
              axis.text = element_text(size = rel(1.0)),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="none",legend.title=element_blank(),
legend.text=element_text(size=10)) +
  coord_cartesian(clip = "off") + 
  facet_wrap(~disease,scales="free")

p

ggsave(plot = print(p),output, width = width, height = height, dpi = 300)

}}


```


```{r}

res_TUCR_LGG <- read_csv(paste("Outputs_LGG_cortex_20230809/ExpressionAnalysis/DESeq2Results/LGG_results_",filterannot,".csv",sep=""),col_names = TRUE)

res_TUCR_GBM <- read_csv(paste("Outputs_GBM_cortex_20230809/ExpressionAnalysis/DESeq2Results/GBM_results_",filterannot,".csv",sep=""),col_names = TRUE)

tucr_annot <- read_delim("hg38.ultraconserved.bed",col_names = TRUE,delim="\t") 

res_TUCR_LGG_2 <- res_TUCR_LGG %>%
  separate(row,into=c("alias","kibble"),sep="___") %>%
  dplyr::select(-kibble) %>% 
  left_join(tucr_annot,by="alias") %>%
  filter(!is.na(chrom)) %>%
  dplyr::select(alias,annot,log2FoldChange,padj) %>%
  mutate(disease = "LGG")

res_TUCR_GBM_2 <- res_TUCR_GBM %>%
  separate(row,into=c("alias","kibble"),sep="___") %>%
  dplyr::select(-kibble) %>% 
  left_join(tucr_annot,by="alias") %>%
  filter(!is.na(chrom)) %>%
  dplyr::select(alias,annot,log2FoldChange,padj) %>%
  mutate(disease = "GBM")

res_TUCR <- rbind(res_TUCR_GBM_2,res_TUCR_LGG_2)

volcanoplot_all(res_TUCR,
                         genes = "all",
                         output = paste(outputdir,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot_annot.png",sep=""),
                         height = 7, 
                         width = 14, 
                         dpi = 300,
                         usefacets = TRUE,
                         intergeniconly=FALSE)

volcanoplot_all(res_TUCR,
                         genes = "all",
                         output = paste(outputdir,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot_both.png",sep=""),
                         height = 3, 
                         width = 8, 
                         dpi = 300,
                         usefacets = FALSE,
                         intergeniconly=FALSE)

volcanoplot_all(res_TUCR,
                         genes = "all",
                         output = paste(outputdir,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot_intergenic.png",sep=""),
                         height = 6, 
                         width = 6, 
                         dpi = 300,
                         usefacets = TRUE,
                         intergeniconly=TRUE)



```

```{r}

### Volcano plot

volcanoplot_surv_all <- function (res,
                         genes = "all",
                         title = paste("Deregulated TUCRs in TCGA (",disease,")",sep=""), 
                         output = paste(outputdir,"/ExpressionAnalysis/VolcanoPlots/",disease,"_results_volcanoplot_both.png",sep=""),
                         height = 7, 
                         width = 10, 
                         dpi = 300,
                         usefacets = TRUE,
                         intergeniconly=FALSE){
  #res <- res_surv_TUCR
  #genes <- "all"
  #genes = c("uc.110")
  #title = "Deregulated Genes"
  
  res <- res %>%
  mutate(dereg = ifelse(estimate > 0 & (p_kpm <= 0.05 & p_coxph <= 0.05), "poor prognosis",
                    ifelse(estimate < 0 & (p_kpm <= 0.05 & p_coxph <= 0.05),"good prognosis","no prognosis")),
         deregcount = ifelse(estimate >0 & (p_kpm <= 0.05 & p_coxph <= 0.05), 1,
                    ifelse(estimate <0 & (p_kpm <= 0.05 & p_coxph <= 0.05),-1,0))) %>%
  dplyr::group_by(alias) %>%
  dplyr::mutate(sum = sum(deregcount,na.rm=TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(deregcategory = ifelse(sum == 2, "Poor-Both",
                                ifelse(sum == -2, "Good-Both",
                                ifelse(sum == 1 & dereg == "poor prognosis" & disease == "GBM","Poor-GBM",
                                ifelse(sum == 1  & dereg == "poor prognosis" &  disease == "LGG", "Poor-LGG",
                                ifelse(sum == -1  & dereg == "good prognosis" &  disease == "LGG", "Good-LGG",
                                ifelse(sum == -1  & dereg == "good prognosis" &  disease == "GBM", "Good-GBM","no prognosis")))))),
                color = ifelse(sum == 2, paper_darkpink,
                                ifelse(sum == -2, paper_lightblue,
                                ifelse(sum == 1 & dereg == "poor prognosis" & disease == "GBM",paper_red,
                                ifelse(sum == 1  & dereg == "poor prognosis" &  disease == "LGG", paper_pink,
                                ifelse(sum == -1  & dereg == "good prognosis" &  disease == "LGG", paper_skyblue,
                                ifelse(sum == -1  & dereg == "good prognosis" &  disease == "GBM", paper_blue,
                                ifelse(disease == "GBM",paper_black,paper_gray))))))))
  
  res_summary <- res %>%
    group_by(color) %>%
    dplyr::summarize(n = n())


  ## plot
if(intergeniconly == TRUE){res <- res %>%
  filter(annot == "intergenic")}
  
if(usefacets == TRUE){
  
res_110_up <- res %>%
   filter(color != paper_gray & color != paper_black & estimate > 0) %>%
   dplyr::arrange(desc(estimate)) %>%
   dplyr::group_by(annot) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 5)

res_110_down <- res %>%
   filter(color != paper_gray & color != paper_black  & estimate < 0) %>%
   dplyr::arrange(estimate) %>%
   dplyr::group_by(annot) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   ungroup() %>%
   filter(order_rank <= 5)
  
p <- ggplot(res) +
        #geom_point(aes(x=log2FoldChange, y=-log10(pvalue),col=color)) +
        #geom_hline(yintercept = 1.30,linetype = 2) +
        geom_point(aes(x=estimate,y=-log10(p_coxph),col=color)) +
        geom_hline(yintercept = -log10(0.05),linetype = 2,size=0.5) +
        geom_vline(xintercept = 0,linetype = 2,size=0.5) +
        scale_color_identity(guide = "deregcategory", labels = res$deregcategory, breaks = res$color) +
        #ggtitle(title) +
        guides(color = guide_legend(override.aes = list(size=5))) +
        geom_text_repel(data= res_110_up,aes(x=estimate,y=-log10(p_coxph),color=paper_black, label = res_110_up$alias, force=50,vjust=1.5,hjust=1.5)) +
        geom_text_repel(data= res_110_down,aes(x=estimate,y=-log10(p_coxph),color=paper_black, label = res_110_down$alias, force=50,vjust=1.5,hjust=1.5)) +
        labs(x = "Cox-PH",
        #y = "-log10 adjusted p-value",
        y = "-log10 of adjusted p-value (Cox-PH)",
        color = "Legend") +
        theme(plot.title = element_text(size = rel(2.0), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              strip.background = element_rect(fill="white"),
              axis.title = element_text(size = rel(1.4), face="bold"),
              strip.text = element_text(size = rel(1.4), face="bold"),
              axis.text = element_text(size = rel(1.0)),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="Top",legend.title=element_blank(),
legend.text=element_text(size=10)) +
  coord_cartesian(clip = "off") + 
  facet_wrap(~disease+annot,scales="free",ncol=length(unique(res$annot)))

ggsave(plot = print(p),output, width = width, height = height, dpi = dpi)

}else{
  
res_110_up <- res %>%
   filter(color != paper_gray & color != paper_black & estimate > 0) %>%
   dplyr::arrange(desc(estimate)) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   filter(order_rank <= 5)

res_110_down <- res %>%
   filter(color != paper_gray & color != paper_black  & estimate < 0) %>%
   dplyr::arrange(estimate) %>%
   dplyr::mutate(order_rank= row_number()) %>%
   mutate(maxrank = max(order_rank,na.rm=TRUE)) %>%
   filter(order_rank <= 5)
  
p <- ggplot(res) +
        #geom_point(aes(x=log2FoldChange, y=-log10(pvalue),col=color)) +
        #geom_hline(yintercept = 1.30,linetype = 2) +
        geom_point(aes(x=estimate,y=-log10(p_coxph),col=color)) +
        geom_hline(yintercept = -log10(0.05),linetype = 2,size=0.5) +
        geom_vline(xintercept = 0,linetype = 2,size=0.5) +
        scale_color_identity(guide = "deregcategory", labels = res$deregcategory, breaks = res$color) +
        #ggtitle(title) +
        guides(color = guide_legend(override.aes = list(size=5))) +
        geom_text_repel(data= res_110_up,aes(x=estimate,y=-log10(p_coxph),color=paper_black, label = res_110_up$alias, force=50,vjust=1.5,hjust=1.5)) +
        geom_text_repel(data= res_110_down,aes(x=estimate,y=-log10(p_coxph),color=paper_black, label = res_110_down$alias, force=50,vjust=1.5,hjust=1.5)) +
        labs(x = "Cox-PH",
        #y = "-log10 adjusted p-value",
        y = "-log10 of adjusted p-value (Cox-PH)",
        color = "Legend") +
        theme(plot.title = element_text(size = rel(2.0), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
              strip.background = element_rect(fill="white"),
              axis.title = element_text(size = rel(1.4), face="bold"),
              strip.text = element_text(size = rel(1.4), face="bold"),
              axis.text = element_text(size = rel(1.0)),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
panel.background = element_blank(), axis.line = element_line(colour = "black"),legend.position="Top",legend.title=element_blank(),
legend.text=element_text(size=10)) +
  coord_cartesian(clip = "off") + 
  facet_wrap(~disease,scales="free")

ggsave(plot = print(p),output, width = width, height = height, dpi = dpi)
}}


```

```{r}

surv_TUCR <- read.csv(paste(outputdir_LGG,"/SurvivalAnalysis/SummaryTables/LGG_survival_TUCRs.csv",sep=""),header=TRUE)

ptable <- read.csv(paste(outputdir_LGG,"/SurvivalAnalysis/SummaryTables/LGG_kpm_summary_TUCRs.csv",sep=""),header=TRUE) %>%
  dplyr::select("id"=TUCR,pvalue,method)

colnames(ptable) <- c("alias.x","pvalue","method")

res_surv <- inner_join(ptable,surv_TUCR,by="alias.x") %>%
  dplyr::select("alias"=alias.x,"annot"=annot.x,"p_kpm"=pvalue,method,estimate,std.error,statistic,"p_coxph"=p.value)

res_surv_LGG <- res_surv[complete.cases(res_surv),] %>%
  mutate(disease = "LGG")

surv_TUCR <- read.csv(paste(outputdir_GBM,"/SurvivalAnalysis/SummaryTables/GBM_survival_TUCRs.csv",sep=""),header=TRUE)

ptable <- read.csv(paste(outputdir_GBM,"/SurvivalAnalysis/SummaryTables/GBM_kpm_summary_TUCRs.csv",sep=""),header=TRUE) %>%
  dplyr::select("id"=TUCR,pvalue,method)

colnames(ptable) <- c("alias.x","pvalue","method")

res_surv <- inner_join(ptable,surv_TUCR,by="alias.x") %>%
  dplyr::select("alias"=alias.x,"annot"=annot.x,"p_kpm"=pvalue,method,estimate,std.error,statistic,"p_coxph"=p.value)

res_surv_GBM <- res_surv[complete.cases(res_surv),] %>%
  mutate(disease = "GBM")

res_surv_TUCR <- rbind(res_surv_GBM,res_surv_LGG)

volcanoplot_surv_all(res_surv_TUCR,
                         genes = "all",
                         output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_results_volcanoplot_annot.png",sep=""),
                         height = 7, 
                         width = 14, 
                         dpi = 300,
                         usefacets = TRUE,
                         intergeniconly=FALSE)

volcanoplot_surv_all(res_surv_TUCR,
                         genes = "all",
                         output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_results_volcanoplot_both.png",sep=""),
                         height = 3, 
                         width = 8, 
                         dpi = 300,
                         usefacets = FALSE,
                         intergeniconly=FALSE)

volcanoplot_surv_all(res_surv_GBM,
                         genes = "all",
                         output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_results_volcanoplot_GBM.png",sep=""),
                         height = 3, 
                         width = 8, 
                         dpi = 300,
                         usefacets = FALSE,
                         intergeniconly=FALSE)

volcanoplot_surv_all(res_surv_LGG,
                         genes = "all",
                         output = paste(outputdir,"/SurvivalAnalysis/SummaryFigures/VolcanoPlots/",disease,"_results_volcanoplot_LGG.png",sep=""),
                         height = 4, 
                         width = 8, 
                         dpi = 300,
                         usefacets = FALSE,
                         intergeniconly=FALSE)

```

```{r}

z_rna <- read.csv(paste(outputdir,"/TUCR_zscores.csv",sep="")) %>%
  gather(key = "Sample",value="Z-Score",-X) %>%
  separate(X,into=c("alias","kibble"),sep="___") 

z_rna_uc110 <- z_rna %>%
  filter(alias == "uc.110") %>%
  dplyr::select(-kibble) %>%
  dplyr::mutate(uc110_Score = `Z-Score`)

z_rna_MFRP <- z_rna %>%
  filter(alias == "MFRP") %>%
  dplyr::select(-kibble) %>%
  dplyr::mutate(MFRP_Score = `Z-Score`)

ggplot_cor <- z_rna_uc110 %>%
  left_join(z_rna_MFRP,by="Sample") %>%
  dplyr::select(MFRP_Score,uc110_Score)

corscore <- cor(ggplot_cor$MFRP_Score,ggplot_cor$uc110_Score)

p <- ggplot(ggplot_cor,aes(uc110_Score,MFRP_Score,color="#9b00d2")) +
  geom_point(size=5) +
  scale_color_identity() +
  xlab(paste("TvN Z-Score (uc.110)")) +
                   ylab("TvN Z-Score (MFRP)") +
  ggtitle(paste("cor = ",corscore,")",sep="")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = rel(1.2), hjust = 0.5, face="bold",margin=margin(0,0,0,0)),
        axis.title = element_text(size = rel(1.4), face="bold"),
        axis.text.y = element_text(size = rel(1.4), face="bold"),
        axis.text.x = element_text(size = rel(1.4), face="bold"),
              #panel.grid = element_line(color = "lightgray",size = 0.75),
        legend.position="right",
        legend.title=element_blank(),
        legend.text=element_blank(), 
        plot.margin = unit(c(0,0,0,0), "cm"))

p

ggsave(plot = print(p),paste(outputdir,"/uc110_MFRP_cor.png"),height=5,width=5)

```

